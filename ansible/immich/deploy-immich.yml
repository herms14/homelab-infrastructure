---
# Immich Photo Management Deployment Playbook
# Deploys Immich self-hosted photo/video backup using Docker Compose
#
# Usage: ansible-playbook immich/deploy-immich.yml -l immich-vm01 -v
#
# Services Deployed:
# - Immich Server     (2283)  - Main web interface and API
# - Immich ML         (N/A)   - Machine learning for face/object recognition
# - PostgreSQL        (5432)  - Database with pgvector extension
# - Redis             (6379)  - Cache and job queue
#
# Prerequisites:
# - Docker and Docker Compose installed (use docker/install-docker.yml first)
#
# Storage:
# - Database: Local storage (PostgreSQL requires ownership control)
# - Photos/Videos: NFS storage on ProxmoxData for persistence

- name: Deploy Immich Photo Management
  hosts: media_services
  become: yes

  vars:
    # ============================================
    # CONFIGURATION VARIABLES
    # ============================================

    # Timezone
    timezone: "America/New_York"

    # NFS Configuration - Synology NAS
    nas_ip: "192.168.20.31"

    # Synology mount points
    # 1. Synology homes export (for legacy photos access)
    synology_homes_share: "/volume2/homes"
    synology_homes_mount: "/mnt/synology-root"

    # 2. Legacy photos bind mount (read-only)
    legacy_photos_source: "{{ synology_homes_mount }}/hermes-admin/Photos"
    legacy_photos_mount: "/mnt/synology-photos"

    # 3. Immich uploads share (read-write)
    immich_uploads_share: "/volume2/Immich Photos"
    immich_uploads_mount: "/mnt/immich-uploads"

    # Immich Configuration
    immich_local_dir: "/opt/immich"

    # Immich version (use release tag)
    immich_version: "release"

    # Generate secure secrets
    postgres_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"

    # Database name
    db_database_name: "immich"
    db_username: "postgres"

  tasks:
    # ============================================
    # NFS PREREQUISITES
    # ============================================

    - name: Install NFS client packages
      apt:
        name:
          - nfs-common
          - nfs4-acl-tools
        state: present
        update_cache: yes

    # ============================================
    # SYNOLOGY NFS MOUNTS
    # ============================================

    - name: Create mount point directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ synology_homes_mount }}"
        - "{{ legacy_photos_mount }}"
        - "{{ immich_uploads_mount }}"

    # Mount 1: Synology homes (RO) - for legacy photos access
    - name: Add Synology homes NFS mount to fstab (RO)
      mount:
        path: "{{ synology_homes_mount }}"
        src: "{{ nas_ip }}:{{ synology_homes_share }}"
        fstype: nfs4
        opts: ro,vers=4,_netdev,nofail
        state: mounted
      register: synology_homes_mount_result

    # Mount 2: Bind mount legacy photos (RO)
    - name: Add legacy photos bind mount to fstab (RO)
      mount:
        path: "{{ legacy_photos_mount }}"
        src: "{{ legacy_photos_source }}"
        fstype: none
        opts: bind,ro
        state: mounted
      register: legacy_photos_mount_result

    # Mount 3: Immich uploads share (RW)
    - name: Add Immich uploads NFS mount to fstab (RW)
      mount:
        path: "{{ immich_uploads_mount }}"
        src: "{{ nas_ip }}:{{ immich_uploads_share }}"
        fstype: nfs4
        opts: rw,vers=4,_netdev,nofail
        state: mounted
      register: immich_uploads_mount_result

    - name: Verify NFS mounts
      command: mount | grep -E "synology|immich"
      register: nfs_mount_check
      changed_when: false
      ignore_errors: yes

    - name: Display NFS mount status
      debug:
        msg: "{{ nfs_mount_check.stdout_lines }}"
      when: nfs_mount_check.stdout_lines | length > 0

    # ============================================
    # DIRECTORY STRUCTURE
    # ============================================

    - name: Create local Immich directories
      # PostgreSQL and ML models need local storage
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ immich_local_dir }}"
        - "{{ immich_local_dir }}/postgres"
        - "{{ immich_local_dir }}/model-cache"

    - name: Verify legacy photos are accessible (RO)
      stat:
        path: "{{ legacy_photos_mount }}"
      register: legacy_photos_stat
      failed_when: not legacy_photos_stat.stat.exists

    - name: Verify Immich uploads mount is writable
      file:
        path: "{{ immich_uploads_mount }}/.ansible_write_test"
        state: touch
        mode: "0644"
      register: uploads_write_test
      ignore_errors: yes

    - name: Clean up write test file
      file:
        path: "{{ immich_uploads_mount }}/.ansible_write_test"
        state: absent
      when: uploads_write_test is succeeded

    - name: Create Immich upload directory structure
      # Immich requires these directories with marker files for integrity checks
      file:
        path: "{{ immich_uploads_mount }}/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - thumbs
        - upload
        - backups
        - library
        - profile
        - encoded-video

    - name: Create Immich integrity marker files
      file:
        path: "{{ immich_uploads_mount }}/{{ item }}/.immich"
        state: touch
        mode: "0644"
      loop:
        - thumbs
        - upload
        - backups
        - library
        - profile
        - encoded-video

    # ============================================
    # SECRETS MANAGEMENT
    # ============================================

    - name: Check if secrets file exists
      stat:
        path: "{{ immich_local_dir }}/.secrets"
      register: secrets_file

    - name: Generate and save secrets (first run only)
      copy:
        dest: "{{ immich_local_dir }}/.secrets"
        content: |
          DB_PASSWORD={{ postgres_password }}
        mode: "0600"
      when: not secrets_file.stat.exists

    - name: Read existing secrets
      slurp:
        src: "{{ immich_local_dir }}/.secrets"
      register: existing_secrets
      when: secrets_file.stat.exists

    - name: Parse existing secrets
      set_fact:
        postgres_password: "{{ (existing_secrets.content | b64decode | regex_search('DB_PASSWORD=(.+)', '\\1'))[0] }}"
      when: secrets_file.stat.exists

    # ============================================
    # DOCKER COMPOSE DEPLOYMENT
    # ============================================

    - name: Deploy Docker Compose file
      copy:
        dest: "{{ immich_local_dir }}/docker-compose.yml"
        mode: "0644"
        content: |
          # Immich Photo Management - Docker Compose Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}
          #
          # Based on official Immich docker-compose
          # https://immich.app/docs/install/docker-compose

          name: immich

          services:
            # ============================================
            # IMMICH SERVER
            # ============================================
            immich-server:
              container_name: immich-server
              image: ghcr.io/immich-app/immich-server:{{ immich_version }}
              restart: unless-stopped
              volumes:
                # Active uploads on Synology (RW)
                - {{ immich_uploads_mount }}:/usr/src/app/upload
                # Legacy photos from Synology (RO external library)
                - {{ legacy_photos_mount }}:/usr/src/app/external/synology:ro
                - /etc/localtime:/etc/localtime:ro
              environment:
                DB_PASSWORD: {{ postgres_password }}
                DB_USERNAME: {{ db_username }}
                DB_DATABASE_NAME: {{ db_database_name }}
                DB_HOSTNAME: immich-postgres
                REDIS_HOSTNAME: immich-redis
              ports:
                - "2283:2283"
              depends_on:
                - immich-redis
                - immich-postgres
              networks:
                - immich-network
              healthcheck:
                test: ["CMD", "wget", "-q", "--spider", "http://localhost:2283/api/server/ping"]
                interval: 30s
                timeout: 10s
                retries: 5
                start_period: 30s

            # ============================================
            # IMMICH MACHINE LEARNING
            # ============================================
            immich-machine-learning:
              container_name: immich-ml
              image: ghcr.io/immich-app/immich-machine-learning:{{ immich_version }}
              restart: unless-stopped
              volumes:
                # ML model cache on local storage
                - {{ immich_local_dir }}/model-cache:/cache
              networks:
                - immich-network

            # ============================================
            # REDIS CACHE
            # ============================================
            immich-redis:
              container_name: immich-redis
              image: docker.io/redis:6.2-alpine
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 10s
                timeout: 5s
                retries: 5
              networks:
                - immich-network

            # ============================================
            # POSTGRESQL DATABASE
            # ============================================
            immich-postgres:
              container_name: immich-postgres
              image: docker.io/tensorchord/pgvecto-rs:pg14-v0.2.0
              restart: unless-stopped
              environment:
                POSTGRES_PASSWORD: {{ postgres_password }}
                POSTGRES_USER: {{ db_username }}
                POSTGRES_DB: {{ db_database_name }}
                POSTGRES_INITDB_ARGS: '--data-checksums'
              volumes:
                # Database on local storage
                - {{ immich_local_dir }}/postgres:/var/lib/postgresql/data
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -d {{ db_database_name }} -U {{ db_username }}"]
                interval: 10s
                timeout: 5s
                retries: 5
              networks:
                - immich-network

          networks:
            immich-network:
              driver: bridge

    # ============================================
    # START THE STACK
    # ============================================

    - name: Start Immich stack with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ immich_local_dir }}"
        state: present
        pull: always
      register: compose_result

    # ============================================
    # VERIFICATION
    # ============================================

    - name: Wait for services to start
      pause:
        seconds: 45

    - name: Check running containers
      command: docker ps --format "table {{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Ports{{'}}'}}"
      register: container_status
      changed_when: false

    - name: Display running containers
      debug:
        msg: "{{ container_status.stdout_lines }}"

    - name: Wait for Immich to be ready
      uri:
        url: "http://localhost:2283/api/server/ping"
        method: GET
        status_code: 200
      register: health_check
      retries: 12
      delay: 10
      until: health_check.status == 200
      ignore_errors: yes

    # ============================================
    # POST-DEPLOYMENT INFO
    # ============================================

    - name: Display access information
      debug:
        msg: |
          ============================================
          IMMICH DEPLOYED SUCCESSFULLY!
          ============================================

          Access your Immich instance:

          Web Interface:
            - URL: http://{{ ansible_host }}:2283

          Initial Setup:
            1. Navigate to http://{{ ansible_host }}:2283
            2. Create your admin account
            3. Download mobile app from App Store / Play Store
            4. Configure backup settings in the app

          Storage Layout:
            Local ({{ immich_local_dir }}):
              - Docker Compose: {{ immich_local_dir }}/docker-compose.yml
              - PostgreSQL: {{ immich_local_dir }}/postgres
              - ML Models: {{ immich_local_dir }}/model-cache
              - Secrets: {{ immich_local_dir }}/.secrets

            Synology NAS (Active Uploads - RW):
              - Host: {{ immich_uploads_mount }}
              - Container: /usr/src/app/upload
              - NAS Path: {{ nas_ip }}:{{ immich_uploads_share }}

            Synology NAS (Legacy Photos - RO):
              - Host: {{ legacy_photos_mount }}
              - Container: /usr/src/app/external/synology
              - NAS Path: {{ nas_ip }}:{{ synology_homes_share }}/hermes-admin/Photos

          External Library Setup:
            1. Go to Admin → External Libraries
            2. Add library with path: /usr/src/app/external/synology
            3. Click "Scan" to import legacy photos
            4. Monitor progress in Admin → Jobs

          Mobile App Setup:
            1. Download Immich app
            2. Server URL: http://{{ ansible_host }}:2283/api
            3. Login with your credentials
            4. Enable backup in app settings

          Useful Commands:
            # View logs
            cd {{ immich_local_dir }} && docker compose logs -f

            # Restart services
            cd {{ immich_local_dir }} && docker compose restart

            # Update Immich
            cd {{ immich_local_dir }} && docker compose pull && docker compose up -d

          ============================================
