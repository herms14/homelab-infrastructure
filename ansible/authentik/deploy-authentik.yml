---
# Authentik Identity Provider Deployment Playbook
# Deploys Authentik SSO/Identity Management using Docker Compose
#
# Usage: ansible-playbook authentik/deploy-authentik.yml -l authentik-vm01 -v
#
# Services Deployed:
# - Authentik Server    (9000)  - Main web interface and API
# - Authentik Worker    (N/A)   - Background task processing
# - PostgreSQL          (5432)  - Database backend
# - Redis               (6379)  - Cache and session storage
#
# Prerequisites:
# - Docker and Docker Compose installed (use docker/install-docker.yml first)
# - NFS share accessible for persistent storage
#
# Storage:
# - App configs stored on NAS at /volume2/ProxmoxData/authentik

- name: Deploy Authentik Identity Provider
  hosts: identity_management
  become: yes

  vars:
    # ============================================
    # CONFIGURATION VARIABLES
    # ============================================

    # User/Group IDs for container permissions
    puid: 1001
    pgid: 1001

    # Timezone
    timezone: "America/New_York"

    # NFS Configuration
    nas_ip: "192.168.20.31"
    nas_data_share: "/volume2/ProxmoxData"
    data_mount_point: "/mnt/appdata"

    # Authentik Configuration
    # Database on local storage (PostgreSQL requires ownership control)
    authentik_local_dir: "/opt/authentik"
    # Media/configs on NFS for persistence
    authentik_nfs_dir: "{{ data_mount_point }}/authentik"

    # Generate secure secrets (override these in production!)
    # To generate: openssl rand -base64 36
    authentik_secret_key: "{{ lookup('password', '/dev/null length=50 chars=ascii_letters,digits') }}"
    postgres_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"

    # Authentik version
    authentik_version: "2024.10.4"

  tasks:
    # ============================================
    # NFS PREREQUISITES
    # ============================================

    - name: Install NFS client packages
      apt:
        name:
          - nfs-common
          - nfs4-acl-tools
        state: present
        update_cache: yes

    # ============================================
    # DIRECTORY STRUCTURE
    # ============================================

    - name: Check if mount point exists
      stat:
        path: "{{ data_mount_point }}"
      register: mount_point_stat

    - name: Create NFS mount point
      file:
        path: "{{ data_mount_point }}"
        state: directory
      when: not mount_point_stat.stat.exists

    - name: Add NFS mount to fstab
      lineinfile:
        path: /etc/fstab
        line: "{{ nas_ip }}:{{ nas_data_share }} {{ data_mount_point }} nfs rw,soft,intr,timeo=300,retrans=3,_netdev,nofail 0 0"
        state: present
        create: yes

    - name: Mount NFS share
      mount:
        path: "{{ data_mount_point }}"
        src: "{{ nas_ip }}:{{ nas_data_share }}"
        fstype: nfs
        opts: rw,soft,intr,timeo=300,retrans=3,_netdev,nofail
        state: mounted
      register: nfs_mount_result
      ignore_errors: yes

    - name: Verify NFS mount
      command: df -h {{ data_mount_point }}
      register: nfs_mount_check
      changed_when: false
      when: not (nfs_mount_result.failed | default(false))

    - name: Display NFS mount status
      debug:
        msg: "{{ nfs_mount_check.stdout }}"
      when: not (nfs_mount_result.failed | default(false))

    - name: Create local Authentik directories
      # All Authentik data on local storage (NFS all_squash incompatible with Authentik)
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ authentik_local_dir }}"
        - "{{ authentik_local_dir }}/postgres"
        - "{{ authentik_local_dir }}/redis"
        - "{{ authentik_local_dir }}/media"
        - "{{ authentik_local_dir }}/templates"
        - "{{ authentik_local_dir }}/certs"

    - name: Create backup marker on NFS
      # Create a marker directory for potential future backups
      file:
        path: "{{ authentik_nfs_dir }}"
        state: directory
        mode: "0777"
      ignore_errors: yes

    # ============================================
    # SECRETS MANAGEMENT
    # ============================================

    - name: Check if secrets file exists
      stat:
        path: "{{ authentik_local_dir }}/.secrets"
      register: secrets_file

    - name: Generate and save secrets (first run only)
      copy:
        dest: "{{ authentik_local_dir }}/.secrets"
        content: |
          AUTHENTIK_SECRET_KEY={{ authentik_secret_key }}
          POSTGRES_PASSWORD={{ postgres_password }}
        mode: "0600"
      when: not secrets_file.stat.exists

    - name: Read existing secrets
      slurp:
        src: "{{ authentik_local_dir }}/.secrets"
      register: existing_secrets
      when: secrets_file.stat.exists

    - name: Parse existing secrets
      set_fact:
        authentik_secret_key: "{{ (existing_secrets.content | b64decode | regex_search('AUTHENTIK_SECRET_KEY=(.+)', '\\1'))[0] }}"
        postgres_password: "{{ (existing_secrets.content | b64decode | regex_search('POSTGRES_PASSWORD=(.+)', '\\1'))[0] }}"
      when: secrets_file.stat.exists

    # ============================================
    # DOCKER COMPOSE DEPLOYMENT
    # ============================================

    - name: Deploy Docker Compose file
      copy:
        dest: "{{ authentik_local_dir }}/docker-compose.yml"
        mode: "0644"
        content: |
          # Authentik Identity Provider - Docker Compose Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}
          #
          # All data stored locally at {{ authentik_local_dir }}
          # NOTE: NFS not used due to all_squash permission restrictions

          services:
            # ============================================
            # POSTGRESQL DATABASE
            # ============================================
            postgresql:
              image: docker.io/library/postgres:16-alpine
              container_name: authentik-postgres
              restart: unless-stopped
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
                start_period: 20s
                interval: 30s
                retries: 5
                timeout: 5s
              volumes:
                # Local storage for database (requires ownership control)
                - {{ authentik_local_dir }}/postgres:/var/lib/postgresql/data
              environment:
                POSTGRES_PASSWORD: {{ postgres_password }}
                POSTGRES_USER: authentik
                POSTGRES_DB: authentik
              networks:
                - authentik-network

            # ============================================
            # REDIS CACHE
            # ============================================
            redis:
              image: docker.io/library/redis:alpine
              container_name: authentik-redis
              command: --save 60 1 --loglevel warning
              restart: unless-stopped
              healthcheck:
                test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
                start_period: 20s
                interval: 30s
                retries: 5
                timeout: 3s
              volumes:
                # Local storage for cache
                - {{ authentik_local_dir }}/redis:/data
              networks:
                - authentik-network

            # ============================================
            # AUTHENTIK SERVER
            # ============================================
            server:
              image: ghcr.io/goauthentik/server:{{ authentik_version }}
              container_name: authentik-server
              restart: unless-stopped
              command: server
              environment:
                AUTHENTIK_REDIS__HOST: redis
                AUTHENTIK_POSTGRESQL__HOST: postgresql
                AUTHENTIK_POSTGRESQL__USER: authentik
                AUTHENTIK_POSTGRESQL__NAME: authentik
                AUTHENTIK_POSTGRESQL__PASSWORD: {{ postgres_password }}
                AUTHENTIK_SECRET_KEY: {{ authentik_secret_key }}
              volumes:
                # Local storage for media and templates
                - {{ authentik_local_dir }}/media:/media
                - {{ authentik_local_dir }}/templates:/templates
              ports:
                - "9000:9000"
                - "9443:9443"
              depends_on:
                postgresql:
                  condition: service_healthy
                redis:
                  condition: service_healthy
              networks:
                - authentik-network

            # ============================================
            # AUTHENTIK WORKER
            # ============================================
            worker:
              image: ghcr.io/goauthentik/server:{{ authentik_version }}
              container_name: authentik-worker
              restart: unless-stopped
              command: worker
              environment:
                AUTHENTIK_REDIS__HOST: redis
                AUTHENTIK_POSTGRESQL__HOST: postgresql
                AUTHENTIK_POSTGRESQL__USER: authentik
                AUTHENTIK_POSTGRESQL__NAME: authentik
                AUTHENTIK_POSTGRESQL__PASSWORD: {{ postgres_password }}
                AUTHENTIK_SECRET_KEY: {{ authentik_secret_key }}
              user: root
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                # Local storage for media, templates, certs
                - {{ authentik_local_dir }}/media:/media
                - {{ authentik_local_dir }}/templates:/templates
                - {{ authentik_local_dir }}/certs:/certs
              depends_on:
                postgresql:
                  condition: service_healthy
                redis:
                  condition: service_healthy
              networks:
                - authentik-network

          networks:
            authentik-network:
              driver: bridge

    # ============================================
    # START THE STACK
    # ============================================

    - name: Start Authentik stack with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ authentik_local_dir }}"
        state: present
        pull: always
      register: compose_result

    # ============================================
    # VERIFICATION
    # ============================================

    - name: Wait for services to start
      pause:
        seconds: 30

    - name: Check running containers
      command: docker ps --format "table {{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Ports{{'}}'}}"
      register: container_status
      changed_when: false

    - name: Display running containers
      debug:
        msg: "{{ container_status.stdout_lines }}"

    - name: Wait for Authentik to be ready
      uri:
        url: "http://localhost:9000/-/health/ready/"
        method: GET
        status_code: 200
      register: health_check
      retries: 12
      delay: 10
      until: health_check.status == 200
      ignore_errors: yes

    # ============================================
    # POST-DEPLOYMENT INFO
    # ============================================

    - name: Display access information
      debug:
        msg: |
          ============================================
          AUTHENTIK DEPLOYED SUCCESSFULLY!
          ============================================

          Access your Authentik instance:

          Web Interface:
            - HTTP:  http://{{ ansible_host }}:9000
            - HTTPS: https://{{ ansible_host }}:9443

          Initial Setup:
            1. Navigate to http://{{ ansible_host }}:9000/if/flow/initial-setup/
            2. Create your admin account
            3. The default admin username will be 'akadmin'

          Storage Location: {{ authentik_local_dir }}
            - Docker Compose: {{ authentik_local_dir }}/docker-compose.yml
            - PostgreSQL: {{ authentik_local_dir }}/postgres
            - Redis: {{ authentik_local_dir }}/redis
            - Media: {{ authentik_local_dir }}/media
            - Templates: {{ authentik_local_dir }}/templates
            - Certs: {{ authentik_local_dir }}/certs
            - Secrets: {{ authentik_local_dir }}/.secrets

          NOTE: NFS storage not used due to all_squash permission restrictions.
          Backup this directory: {{ authentik_local_dir }}

          Useful Commands:
            # View logs
            cd {{ authentik_local_dir }} && docker compose logs -f

            # Restart services
            cd {{ authentik_local_dir }} && docker compose restart

            # Update Authentik
            cd {{ authentik_local_dir }} && docker compose pull && docker compose up -d

          ============================================
