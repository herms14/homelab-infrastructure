---
# Glance Dashboard Deployment Playbook
# Deploys Glance self-hosted dashboard using Docker Compose
#
# Usage: ansible-playbook glance/deploy-glance.yml -l docker-vm-utilities01 -v
#
# Services Deployed:
# - Glance Dashboard    (8080)  - Main dashboard interface
#
# Prerequisites:
# - Docker and Docker Compose installed (use docker/install-docker.yml first)
#
# Storage:
# - Configuration stored locally at /opt/glance

- name: Deploy Glance Dashboard
  hosts: all
  become: yes

  vars:
    # ============================================
    # CONFIGURATION VARIABLES
    # ============================================

    # Timezone
    timezone: "America/New_York"

    # Glance Configuration
    glance_dir: "/opt/glance"

    # Dashboard settings
    hour_format: "12h"
    location: "New York, New York, United States"

  tasks:
    # ============================================
    # PREREQUISITES
    # ============================================

    - name: Ensure Docker is installed
      command: docker --version
      register: docker_check
      changed_when: false
      failed_when: false

    - name: Fail if Docker is not installed
      fail:
        msg: "Docker is not installed. Please run docker/install-docker.yml first."
      when: docker_check.rc != 0

    # ============================================
    # DIRECTORY STRUCTURE
    # ============================================

    - name: Create Glance directory
      file:
        path: "{{ glance_dir }}"
        state: directory
        mode: "0755"

    # ============================================
    # GLANCE CONFIGURATION
    # ============================================

    - name: Deploy Glance configuration file
      copy:
        dest: "{{ glance_dir }}/glance.yml"
        mode: "0644"
        content: |
          # Glance Dashboard Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          pages:
            - name: Home
              columns:
                - size: small
                  widgets:
                    - type: calendar

                - size: full
                  widgets:
                    - type: rss
                      limit: 10
                      collapse-after: 3
                      cache: 3h
                      feeds:
                        - url: https://hnrss.org/frontpage
                          title: Hacker News
                        - url: https://feeds.arstechnica.com/arstechnica/index
                          title: Ars Technica

                    - type: weather
                      location: {{ location }}

                - size: small
                  widgets:
                    - type: bookmarks
                      groups:
                        - links:
                            - title: GitHub
                              url: https://github.com
                            - title: Reddit
                              url: https://reddit.com
                            - title: YouTube
                              url: https://youtube.com

                    - type: clock
                      hour-format: {{ hour_format }}
                      timezones:
                        - timezone: America/New_York
                          label: New York
                        - timezone: Europe/London
                          label: London
                        - timezone: Asia/Tokyo
                          label: Tokyo

    # ============================================
    # DOCKER COMPOSE DEPLOYMENT
    # ============================================

    - name: Deploy Docker Compose file
      copy:
        dest: "{{ glance_dir }}/docker-compose.yml"
        mode: "0644"
        content: |
          # Glance Dashboard - Docker Compose Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          services:
            glance:
              image: glanceapp/glance:latest
              container_name: glance
              restart: unless-stopped
              ports:
                - 8080:8080
              volumes:
                - ./glance.yml:/app/glance.yml
                - /etc/timezone:/etc/timezone:ro
                - /etc/localtime:/etc/localtime:ro
              environment:
                - TZ={{ timezone }}

    # ============================================
    # START THE STACK
    # ============================================

    - name: Start Glance stack with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ glance_dir }}"
        state: present
        pull: always
      register: compose_result

    # ============================================
    # VERIFICATION
    # ============================================

    - name: Wait for service to start
      pause:
        seconds: 15

    - name: Check running containers
      command: docker ps --format "table {{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Ports{{'}}'}}"
      register: container_status
      changed_when: false

    - name: Display running containers
      debug:
        msg: "{{ container_status.stdout_lines }}"

    - name: Wait for Glance to be ready
      uri:
        url: "http://localhost:8080"
        method: GET
        status_code: 200
      register: health_check
      retries: 6
      delay: 5
      until: health_check.status == 200
      ignore_errors: yes

    # ============================================
    # POST-DEPLOYMENT INFO
    # ============================================

    - name: Display access information
      debug:
        msg: |
          ============================================
          GLANCE DASHBOARD DEPLOYED SUCCESSFULLY!
          ============================================

          Access your Glance dashboard:

          Web Interface:
            - HTTP: http://{{ ansible_host }}:8080

          Configuration:
            - Dashboard config: {{ glance_dir }}/glance.yml
            - Docker Compose: {{ glance_dir }}/docker-compose.yml

          Customization:
            1. Edit {{ glance_dir }}/glance.yml to customize your dashboard
            2. Add/remove widgets, RSS feeds, bookmarks, etc.
            3. Restart the container to apply changes:
               cd {{ glance_dir }} && docker compose restart

          Useful Commands:
            # View logs
            cd {{ glance_dir }} && docker compose logs -f

            # Restart service
            cd {{ glance_dir }} && docker compose restart

            # Update Glance
            cd {{ glance_dir }} && docker compose pull && docker compose up -d

            # Edit configuration
            nano {{ glance_dir }}/glance.yml

          Widget Types Available:
            - calendar: Shows current month calendar
            - clock: Multiple timezone clocks
            - weather: Weather forecast
            - rss: RSS feed reader
            - bookmarks: Quick link bookmarks
            - monitor: System monitoring
            - and many more...

          Documentation:
            https://github.com/glanceapp/glance

          ============================================
