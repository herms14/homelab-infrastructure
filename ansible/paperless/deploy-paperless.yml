---
# Paperless-ngx Document Management Deployment Playbook
# Deploys Paperless-ngx document management system using Docker Compose
#
# Usage: ansible-playbook paperless/deploy-paperless.yml -l docker-vm-utilities01 -v
#
# Services Deployed:
# - Paperless-ngx       (8000)  - Main web interface and document processing
# - PostgreSQL          (5432)  - Database backend
# - Redis               (6379)  - Cache and task queue
#
# Prerequisites:
# - Docker and Docker Compose installed (use docker/install-docker.yml first)
#
# Storage:
# - App configs and media stored locally at /opt/paperless-ngx

- name: Deploy Paperless-ngx Document Management
  hosts: all
  become: yes

  vars:
    # ============================================
    # CONFIGURATION VARIABLES
    # ============================================

    # User/Group IDs for container permissions
    usermap_uid: 1001
    usermap_gid: 1001

    # Timezone
    timezone: "America/New_York"

    # Paperless Configuration
    paperless_dir: "/opt/paperless-ngx"

    # Database credentials
    postgres_db: "paperless"
    postgres_user: "paperless"
    postgres_password: "paperless"

    # Paperless settings
    paperless_secret_key: "{{ lookup('password', '/dev/null length=50 chars=ascii_letters,digits') }}"
    paperless_ocr_language: "eng"
    paperless_url: "http://{{ ansible_host }}:8000"

  tasks:
    # ============================================
    # PREREQUISITES
    # ============================================

    - name: Ensure Docker is installed
      command: docker --version
      register: docker_check
      changed_when: false
      failed_when: false

    - name: Fail if Docker is not installed
      fail:
        msg: "Docker is not installed. Please run docker/install-docker.yml first."
      when: docker_check.rc != 0

    # ============================================
    # DIRECTORY STRUCTURE
    # ============================================

    - name: Create Paperless-ngx directory structure
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ paperless_dir }}"
        - "{{ paperless_dir }}/data"
        - "{{ paperless_dir }}/media"
        - "{{ paperless_dir }}/export"
        - "{{ paperless_dir }}/consume"

    # ============================================
    # SECRETS MANAGEMENT
    # ============================================

    - name: Check if secrets file exists
      stat:
        path: "{{ paperless_dir }}/.secrets"
      register: secrets_file

    - name: Generate and save secrets (first run only)
      copy:
        dest: "{{ paperless_dir }}/.secrets"
        content: |
          PAPERLESS_SECRET_KEY={{ paperless_secret_key }}
          POSTGRES_PASSWORD={{ postgres_password }}
        mode: "0600"
      when: not secrets_file.stat.exists

    - name: Read existing secrets
      slurp:
        src: "{{ paperless_dir }}/.secrets"
      register: existing_secrets
      when: secrets_file.stat.exists

    - name: Parse existing secrets
      set_fact:
        paperless_secret_key: "{{ (existing_secrets.content | b64decode | regex_search('PAPERLESS_SECRET_KEY=(.+)', '\\1'))[0] }}"
        postgres_password: "{{ (existing_secrets.content | b64decode | regex_search('POSTGRES_PASSWORD=(.+)', '\\1'))[0] }}"
      when: secrets_file.stat.exists

    # ============================================
    # DOCKER COMPOSE DEPLOYMENT
    # ============================================

    - name: Deploy Docker Compose file
      copy:
        dest: "{{ paperless_dir }}/docker-compose.yml"
        mode: "0644"
        content: |
          # Paperless-ngx Document Management - Docker Compose Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          services:
            # ============================================
            # REDIS CACHE
            # ============================================
            broker:
              image: redis:7
              container_name: paperless-redis
              restart: unless-stopped
              volumes:
                - redis_data:/data
              networks:
                - paperless

            # ============================================
            # POSTGRESQL DATABASE
            # ============================================
            db:
              image: postgres:16
              container_name: paperless-db
              restart: unless-stopped
              volumes:
                - postgres_data:/var/lib/postgresql/data
              environment:
                POSTGRES_DB: {{ postgres_db }}
                POSTGRES_USER: {{ postgres_user }}
                POSTGRES_PASSWORD: {{ postgres_password }}
              networks:
                - paperless

            # ============================================
            # PAPERLESS-NGX SERVER
            # ============================================
            webserver:
              image: ghcr.io/paperless-ngx/paperless-ngx:latest
              container_name: paperless-ngx
              restart: unless-stopped
              depends_on:
                - db
                - broker
              ports:
                - 8000:8000
              volumes:
                - ./data:/usr/src/paperless/data
                - ./media:/usr/src/paperless/media
                - ./export:/usr/src/paperless/export
                - ./consume:/usr/src/paperless/consume
              environment:
                PAPERLESS_REDIS: redis://broker:6379
                PAPERLESS_DBHOST: db
                PAPERLESS_DBNAME: {{ postgres_db }}
                PAPERLESS_DBUSER: {{ postgres_user }}
                PAPERLESS_DBPASS: {{ postgres_password }}
                PAPERLESS_TIME_ZONE: {{ timezone }}
                PAPERLESS_OCR_LANGUAGE: {{ paperless_ocr_language }}
                PAPERLESS_SECRET_KEY: {{ paperless_secret_key }}
                PAPERLESS_URL: {{ paperless_url }}
                USERMAP_UID: {{ usermap_uid }}
                USERMAP_GID: {{ usermap_gid }}
              networks:
                - paperless

          volumes:
            redis_data:
            postgres_data:

          networks:
            paperless:
              driver: bridge

    # ============================================
    # START THE STACK
    # ============================================

    - name: Start Paperless-ngx stack with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ paperless_dir }}"
        state: present
        pull: always
      register: compose_result

    # ============================================
    # VERIFICATION
    # ============================================

    - name: Wait for services to start
      pause:
        seconds: 30

    - name: Check running containers
      command: docker ps --format "table {{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Ports{{'}}'}}"
      register: container_status
      changed_when: false

    - name: Display running containers
      debug:
        msg: "{{ container_status.stdout_lines }}"

    - name: Wait for Paperless-ngx to be ready
      uri:
        url: "http://localhost:8000"
        method: GET
        status_code: 200
      register: health_check
      retries: 12
      delay: 10
      until: health_check.status == 200
      ignore_errors: yes

    # ============================================
    # POST-DEPLOYMENT INFO
    # ============================================

    - name: Display access information
      debug:
        msg: |
          ============================================
          PAPERLESS-NGX DEPLOYED SUCCESSFULLY!
          ============================================

          Access your Paperless-ngx instance:

          Web Interface:
            - HTTP: http://{{ ansible_host }}:8000

          Initial Setup:
            1. Navigate to http://{{ ansible_host }}:8000
            2. Create your admin account on first login
            3. Upload documents via the web interface or place them in the consume folder

          Storage Location: {{ paperless_dir }}
            - Docker Compose: {{ paperless_dir }}/docker-compose.yml
            - Documents (processed): {{ paperless_dir }}/media
            - Documents (incoming): {{ paperless_dir }}/consume
            - Data: {{ paperless_dir }}/data
            - Exports: {{ paperless_dir }}/export
            - Secrets: {{ paperless_dir }}/.secrets

          Document Import:
            - Place documents in {{ paperless_dir }}/consume
            - Paperless will automatically process and import them

          Useful Commands:
            # View logs
            cd {{ paperless_dir }} && docker compose logs -f

            # Restart services
            cd {{ paperless_dir }} && docker compose restart

            # Update Paperless-ngx
            cd {{ paperless_dir }} && docker compose pull && docker compose up -d

            # Access Django admin
            docker exec -it paperless-ngx python manage.py createsuperuser

          ============================================
