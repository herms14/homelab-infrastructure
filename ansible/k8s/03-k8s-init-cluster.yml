---
################################################################################
# Kubernetes Cluster Initialization Playbook
################################################################################
# This playbook initializes the Kubernetes cluster on the primary control plane:
# 1. Runs kubeadm init on first control plane node
# 2. Sets up kubeconfig for admin user
# 3. Generates join commands for additional control planes and workers
# 4. Saves join commands to files for use by other playbooks
#
# This playbook should be run AFTER:
# - 01-k8s-prerequisites.yml
# - 02-k8s-install.yml
#
# This playbook is idempotent - will skip if cluster already initialized
################################################################################

- name: Initialize Kubernetes Cluster on Primary Control Plane
  hosts: k8s_control_plane
  become: yes
  gather_facts: yes

  tasks:
    ############################################################################
    # PRE-INITIALIZATION CHECKS
    ############################################################################
    # Check if cluster is already initialized to make playbook idempotent
    ############################################################################

    - name: Check if Kubernetes cluster is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_initialized

    - name: Check if kubelet is already running
      command: systemctl is-active kubelet
      register: kubelet_status
      changed_when: false
      failed_when: false

    ############################################################################
    # PRIMARY CONTROL PLANE INITIALIZATION
    ############################################################################
    # Initialize cluster ONLY on the primary control plane node
    # Other control planes will join using the join command
    ############################################################################

    - name: Initialize Kubernetes cluster on primary control plane
      command: >
        kubeadm init
        --control-plane-endpoint="{{ hostvars['k8s-controller01']['ansible_host'] }}:6443"
        --upload-certs
        --pod-network-cidr={{ k8s_pod_network_cidr }}
        --service-cidr={{ k8s_service_cidr }}
        --apiserver-advertise-address={{ ansible_host }}
      register: kubeadm_init
      when:
        - is_primary_control_plane | default(false) | bool
        - not k8s_initialized.stat.exists
      timeout: 600

    - name: Save kubeadm init output for debugging
      copy:
        content: "{{ kubeadm_init.stdout }}"
        dest: /root/kubeadm-init-output.log
        mode: '0600'
      when:
        - is_primary_control_plane | default(false) | bool
        - kubeadm_init is changed

    - name: Wait for Kubernetes API server to be ready
      wait_for:
        host: "{{ ansible_host }}"
        port: 6443
        timeout: 300
      when:
        - is_primary_control_plane | default(false) | bool
        - kubeadm_init is changed

    ############################################################################
    # KUBECONFIG SETUP FOR ROOT USER
    ############################################################################
    # Configure kubectl access for root user on control plane
    # This allows running kubectl commands as root
    ############################################################################

    - name: Create .kube directory for root user
      file:
        path: /root/.kube
        state: directory
        mode: '0755'
      when: is_primary_control_plane | default(false) | bool

    - name: Copy admin.conf to root user's kubeconfig
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        owner: root
        group: root
        mode: '0600'
      when: is_primary_control_plane | default(false) | bool

    ############################################################################
    # KUBECONFIG SETUP FOR ADMIN USER (hermes-admin)
    ############################################################################
    # Configure kubectl access for the admin user
    # This allows non-root user to manage the cluster
    ############################################################################

    - name: Create .kube directory for admin user
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      when: is_primary_control_plane | default(false) | bool

    - name: Copy admin.conf to admin user's kubeconfig
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: yes
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: is_primary_control_plane | default(false) | bool

    ############################################################################
    # GENERATE JOIN COMMANDS
    ############################################################################
    # Generate join commands for:
    # 1. Additional control plane nodes (with --control-plane flag)
    # 2. Worker nodes
    #
    # These commands include tokens that expire after 24 hours
    # For permanent cluster, use bootstrap tokens or certificates
    ############################################################################

    - name: Generate join command for control plane nodes
      command: kubeadm token create --print-join-command
      register: kubeadm_join_control_plane_base
      when: is_primary_control_plane | default(false) | bool
      changed_when: false

    - name: Get certificate key for control plane join
      command: kubeadm init phase upload-certs --upload-certs
      register: kubeadm_cert_key
      when: is_primary_control_plane | default(false) | bool
      changed_when: false

    - name: Extract certificate key from output
      set_fact:
        certificate_key: "{{ kubeadm_cert_key.stdout_lines[-1] }}"
      when: is_primary_control_plane | default(false) | bool

    - name: Build complete control plane join command
      set_fact:
        control_plane_join_command: "{{ kubeadm_join_control_plane_base.stdout }} --control-plane --certificate-key {{ certificate_key }}"
      when: is_primary_control_plane | default(false) | bool

    - name: Generate join command for worker nodes
      command: kubeadm token create --print-join-command
      register: kubeadm_join_worker
      when: is_primary_control_plane | default(false) | bool
      changed_when: false

    ############################################################################
    # SAVE JOIN COMMANDS TO FILES
    ############################################################################
    # Save join commands to files on the primary control plane
    # These files will be used by the 05-k8s-join-nodes.yml playbook
    ############################################################################

    - name: Save control plane join command to file
      copy:
        content: "{{ control_plane_join_command }}"
        dest: /root/kubeadm-join-control-plane.sh
        mode: '0700'
      when: is_primary_control_plane | default(false) | bool

    - name: Save worker join command to file
      copy:
        content: "{{ kubeadm_join_worker.stdout }}"
        dest: /root/kubeadm-join-worker.sh
        mode: '0700'
      when: is_primary_control_plane | default(false) | bool

    ############################################################################
    # FETCH JOIN COMMANDS TO ANSIBLE CONTROLLER
    ############################################################################
    # Fetch join commands to the Ansible controller for easy access
    # This allows running join commands from the controller
    ############################################################################

    - name: Fetch control plane join command to Ansible controller
      fetch:
        src: /root/kubeadm-join-control-plane.sh
        dest: /tmp/kubeadm-join-control-plane.sh
        flat: yes
      when: is_primary_control_plane | default(false) | bool

    - name: Fetch worker join command to Ansible controller
      fetch:
        src: /root/kubeadm-join-worker.sh
        dest: /tmp/kubeadm-join-worker.sh
        flat: yes
      when: is_primary_control_plane | default(false) | bool

    ############################################################################
    # VERIFY CLUSTER STATUS
    ############################################################################
    # Verify cluster is initialized and control plane node is ready
    ############################################################################

    - name: Verify cluster is initialized (check nodes)
      command: kubectl get nodes
      register: kubectl_nodes
      when: is_primary_control_plane | default(false) | bool
      changed_when: false
      become_user: "{{ ansible_user }}"

    - name: Verify cluster is initialized (check pods)
      command: kubectl get pods -A
      register: kubectl_pods
      when: is_primary_control_plane | default(false) | bool
      changed_when: false
      become_user: "{{ ansible_user }}"

    - name: Check cluster component status
      command: kubectl get componentstatuses
      register: component_status
      when: is_primary_control_plane | default(false) | bool
      changed_when: false
      failed_when: false
      become_user: "{{ ansible_user }}"

    ############################################################################
    # INITIALIZATION SUMMARY
    ############################################################################

    - name: Display initialization summary
      debug:
        msg:
          - "=============================================="
          - "Kubernetes Cluster Initialized Successfully"
          - "=============================================="
          - "Primary Control Plane: {{ inventory_hostname }}"
          - "API Server: {{ hostvars['k8s-controller01']['ansible_host'] }}:6443"
          - "Pod Network CIDR: {{ k8s_pod_network_cidr }}"
          - "Service CIDR: {{ k8s_service_cidr }}"
          - ""
          - "Join commands saved to:"
          - "  Control Plane: /root/kubeadm-join-control-plane.sh"
          - "  Workers: /root/kubeadm-join-worker.sh"
          - "  Ansible Controller: /tmp/kubeadm-join-*.sh"
          - ""
          - "Kubeconfig locations:"
          - "  Root: /root/.kube/config"
          - "  Admin: /home/{{ ansible_user }}/.kube/config"
          - ""
          - "Current nodes:"
          - "{{ kubectl_nodes.stdout }}"
          - ""
          - "⚠️  IMPORTANT NOTES:"
          - "1. CNI (Container Network Interface) not yet installed"
          - "2. Nodes will show 'NotReady' until CNI is installed"
          - "3. Run 04-k8s-install-cni.yml to install Calico CNI"
          - "4. Join tokens expire in 24 hours"
          - "5. Certificate key expires in 2 hours"
      when: is_primary_control_plane | default(false) | bool

################################################################################
# POST-INITIALIZATION NOTES
################################################################################
# After this playbook completes:
# 1. Kubernetes cluster is initialized on primary control plane
# 2. Admin user can run kubectl commands
# 3. Join commands are saved for additional nodes
# 4. Cluster is NOT ready for workloads (needs CNI)
#
# Next steps:
# 1. Run 04-k8s-install-cni.yml to install Calico
# 2. Run 05-k8s-join-nodes.yml to join other nodes
################################################################################
