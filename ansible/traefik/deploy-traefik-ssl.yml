---
# Traefik Reverse Proxy with SSL Deployment Playbook
# Deploys Traefik v3 with Let's Encrypt certificates via Cloudflare DNS challenge
#
# Usage: ansible-playbook traefik/deploy-traefik-ssl.yml -l traefik-vm01 -v
#
# Prerequisites:
# - Docker and Docker Compose installed (use docker/install-docker.yml first)
# - Cloudflare API Token with Zone:DNS:Edit permissions
# - OPNsense DNS configured to resolve *.hrmsmrflrii.xyz to 192.168.40.20
# - Observability stack deployed for tracing (deploy-observability-stack.yml)
#
# Features:
# - Let's Encrypt wildcard certificate for *.hrmsmrflrii.xyz
# - Cloudflare DNS-01 challenge (no ports need to be open to internet)
# - OpenTelemetry tracing integration
# - Prometheus metrics endpoint
# - Authentik ForwardAuth protection for admin endpoints
# - 17+ services configured with HTTPS
# - Automatic certificate renewal

- name: Deploy Traefik with SSL (Let's Encrypt + Cloudflare)
  hosts: reverse_proxy
  become: yes

  vars:
    # ============================================
    # CONFIGURATION VARIABLES
    # ============================================

    # Domain configuration
    domain: "hrmsmrflrii.xyz"

    # Let's Encrypt email for certificate notifications
    acme_email: "herms14@gmail.com"

    # Cloudflare API Token (Zone:DNS:Edit permission)
    cloudflare_api_token: "VEfPrEHTI0mVZF-HrnHgtygK9OgKqR93EvXV7tWZ"

    # Timezone
    timezone: "America/New_York"

    # Traefik directories
    traefik_dir: "/opt/traefik"

    # Traefik version
    traefik_version: "v3.2"

    # Backend service IPs
    authentik_ip: "192.168.40.21"
    immich_ip: "192.168.40.22"
    gitlab_ip: "192.168.40.23"
    media_server_ip: "192.168.40.11"
    utilities_server_ip: "192.168.40.10"

    # OpenTelemetry Collector endpoint
    otel_collector_endpoint: "http://192.168.40.10:4318/v1/traces"

    # Metrics port (internal)
    metrics_port: 8082

  tasks:
    # ============================================
    # DIRECTORY STRUCTURE
    # ============================================

    - name: Create Traefik directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ traefik_dir }}"
        - "{{ traefik_dir }}/config"
        - "{{ traefik_dir }}/config/dynamic"
        - "{{ traefik_dir }}/certs"
        - "{{ traefik_dir }}/logs"

    # ============================================
    # ACME CERTIFICATE STORAGE
    # ============================================

    - name: Create acme.json for certificate storage
      file:
        path: "{{ traefik_dir }}/certs/acme.json"
        state: touch
        mode: "0600"
        modification_time: preserve
        access_time: preserve

    # ============================================
    # STATIC CONFIGURATION (with ACME)
    # ============================================

    - name: Deploy Traefik static configuration with SSL
      copy:
        dest: "{{ traefik_dir }}/config/traefik.yml"
        mode: "0644"
        content: |
          # Traefik Static Configuration with Let's Encrypt SSL
          # Domain: {{ domain }}
          # Features: OTEL Tracing, Prometheus Metrics, ForwardAuth

          global:
            checkNewVersion: false
            sendAnonymousUsage: false

          # API and Dashboard
          api:
            dashboard: true
            insecure: false  # Dashboard behind HTTPS

          # Logging
          log:
            level: INFO
            filePath: /logs/traefik.log
            format: json

          # Access Log with trace correlation
          accessLog:
            filePath: /logs/access.log
            format: json
            bufferingSize: 100
            fields:
              defaultMode: keep
              names:
                ClientUsername: drop
              headers:
                defaultMode: keep
                names:
                  User-Agent: keep
                  Authorization: drop
                  X-Request-Id: keep
                  Traceparent: keep

          # OpenTelemetry Tracing
          tracing:
            otlp:
              http:
                endpoint: "{{ otel_collector_endpoint }}"
            serviceName: "traefik"
            sampleRate: 1.0

          # Prometheus Metrics
          metrics:
            prometheus:
              buckets:
                - 0.1
                - 0.3
                - 1.2
                - 5.0
              addEntryPointsLabels: true
              addRoutersLabels: true
              addServicesLabels: true
              entryPoint: metrics

          # Entrypoints
          entryPoints:
            web:
              address: ":80"
              http:
                redirections:
                  entryPoint:
                    to: websecure
                    scheme: https
                    permanent: true
            websecure:
              address: ":443"
              http:
                tls:
                  certResolver: letsencrypt
                  domains:
                    - main: "{{ domain }}"
                      sans:
                        - "*.{{ domain }}"
            metrics:
              address: ":{{ metrics_port }}"

          # Certificate Resolvers (Let's Encrypt)
          certificatesResolvers:
            letsencrypt:
              acme:
                email: "{{ acme_email }}"
                storage: /certs/acme.json
                # Use staging for testing (uncomment to avoid rate limits)
                # caServer: https://acme-staging-v02.api.letsencrypt.org/directory
                dnsChallenge:
                  provider: cloudflare
                  delayBeforeCheck: 10
                  resolvers:
                    - "1.1.1.1:53"
                    - "8.8.8.8:53"

          # Providers
          providers:
            docker:
              endpoint: "unix:///var/run/docker.sock"
              exposedByDefault: false
              network: traefik-network
              watch: true

            file:
              directory: /etc/traefik/dynamic
              watch: true

    # ============================================
    # DYNAMIC CONFIGURATION (All Services)
    # ============================================

    - name: Deploy Traefik dynamic configuration with all services
      copy:
        dest: "{{ traefik_dir }}/config/dynamic/services.yml"
        mode: "0644"
        content: |
          # Traefik Dynamic Configuration - {{ domain }}
          # 17+ Services with SSL via Let's Encrypt
          # Features: Authentik ForwardAuth, Rate Limiting, OTEL Tracing

          http:
            # ==========================================
            # ROUTERS
            # ==========================================
            routers:
              # --- Core Services ---

              traefik-dashboard:
                rule: "Host(`traefik.{{ domain }}`)"
                service: api@internal
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              authentik:
                rule: "Host(`auth.{{ domain }}`)"
                service: authentik
                entryPoints:
                  - websecure
                tls:
                  certResolver: letsencrypt

              immich:
                rule: "Host(`photos.{{ domain }}`)"
                service: immich
                entryPoints:
                  - websecure
                tls:
                  certResolver: letsencrypt

              gitlab:
                rule: "Host(`gitlab.{{ domain }}`)"
                service: gitlab
                entryPoints:
                  - websecure
                tls:
                  certResolver: letsencrypt

              # --- Observability Services (docker-vm-utilities01) ---

              jaeger:
                rule: "Host(`jaeger.{{ domain }}`)"
                service: jaeger
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              prometheus:
                rule: "Host(`prometheus.{{ domain }}`)"
                service: prometheus
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              grafana:
                rule: "Host(`grafana.{{ domain }}`)"
                service: grafana
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              uptime-kuma:
                rule: "Host(`uptime.{{ domain }}`)"
                service: uptime-kuma
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              demo-app:
                rule: "Host(`demo.{{ domain }}`)"
                service: demo-app
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              # --- Media Services (docker-vm-media01) ---

              jellyfin:
                rule: "Host(`jellyfin.{{ domain }}`)"
                service: jellyfin
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              radarr:
                rule: "Host(`radarr.{{ domain }}`)"
                service: radarr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              sonarr:
                rule: "Host(`sonarr.{{ domain }}`)"
                service: sonarr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              lidarr:
                rule: "Host(`lidarr.{{ domain }}`)"
                service: lidarr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              prowlarr:
                rule: "Host(`prowlarr.{{ domain }}`)"
                service: prowlarr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              bazarr:
                rule: "Host(`bazarr.{{ domain }}`)"
                service: bazarr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              overseerr:
                rule: "Host(`overseerr.{{ domain }}`)"
                service: overseerr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              jellyseerr:
                rule: "Host(`jellyseerr.{{ domain }}`)"
                service: jellyseerr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              tdarr:
                rule: "Host(`tdarr.{{ domain }}`)"
                service: tdarr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              autobrr:
                rule: "Host(`autobrr.{{ domain }}`)"
                service: autobrr
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              # --- Utility Services (docker-vm-utilities01) ---

              n8n:
                rule: "Host(`n8n.{{ domain }}`)"
                service: n8n
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              paperless:
                rule: "Host(`paperless.{{ domain }}`)"
                service: paperless
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

              glance:
                rule: "Host(`glance.{{ domain }}`)"
                service: glance
                entryPoints:
                  - websecure
                middlewares:
                  - authentik-auth
                tls:
                  certResolver: letsencrypt

            # ==========================================
            # SERVICES (Backend Servers)
            # ==========================================
            services:
              # --- Core Services ---

              authentik:
                loadBalancer:
                  servers:
                    - url: "http://{{ authentik_ip }}:9000"

              immich:
                loadBalancer:
                  servers:
                    - url: "http://{{ immich_ip }}:2283"

              gitlab:
                loadBalancer:
                  servers:
                    - url: "http://{{ gitlab_ip }}:80"

              # --- Observability Services ---

              jaeger:
                loadBalancer:
                  servers:
                    - url: "http://{{ utilities_server_ip }}:16686"

              prometheus:
                loadBalancer:
                  servers:
                    - url: "http://{{ utilities_server_ip }}:9090"

              grafana:
                loadBalancer:
                  servers:
                    - url: "http://{{ utilities_server_ip }}:3030"

              uptime-kuma:
                loadBalancer:
                  servers:
                    - url: "http://{{ utilities_server_ip }}:3001"

              demo-app:
                loadBalancer:
                  servers:
                    - url: "http://{{ utilities_server_ip }}:8080"

              # --- Media Services ---

              jellyfin:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:8096"

              radarr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:7878"

              sonarr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:8989"

              lidarr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:8686"

              prowlarr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:9696"

              bazarr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:6767"

              overseerr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:5055"

              jellyseerr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:5056"

              tdarr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:8265"

              autobrr:
                loadBalancer:
                  servers:
                    - url: "http://{{ media_server_ip }}:7474"

              # --- Utility Services ---

              n8n:
                loadBalancer:
                  servers:
                    - url: "http://{{ utilities_server_ip }}:5678"

              paperless:
                loadBalancer:
                  servers:
                    - url: "http://{{ utilities_server_ip }}:8000"

              glance:
                loadBalancer:
                  servers:
                    - url: "http://{{ utilities_server_ip }}:8080"

            # ==========================================
            # MIDDLEWARES
            # ==========================================
            middlewares:
              # Authentik ForwardAuth - Protects services with SSO
              authentik-auth:
                forwardAuth:
                  address: "http://{{ authentik_ip }}:9000/outpost.goauthentik.io/auth/traefik"
                  trustForwardHeader: true
                  authResponseHeaders:
                    - X-authentik-username
                    - X-authentik-groups
                    - X-authentik-email
                    - X-authentik-name
                    - X-authentik-uid
                    - X-authentik-jwt
                    - X-authentik-meta-jwks
                    - X-authentik-meta-outpost
                    - X-authentik-meta-provider
                    - X-authentik-meta-app
                    - X-authentik-meta-version

              # Security headers
              secure-headers:
                headers:
                  frameDeny: true
                  browserXssFilter: true
                  contentTypeNosniff: true
                  stsSeconds: 31536000
                  stsIncludeSubdomains: true
                  stsPreload: true
                  customFrameOptionsValue: "SAMEORIGIN"
                  referrerPolicy: "strict-origin-when-cross-origin"

              # Rate limiting middleware
              rate-limit:
                rateLimit:
                  average: 100
                  burst: 50
                  period: 1m

          # ==========================================
          # TLS OPTIONS
          # ==========================================
          tls:
            options:
              default:
                minVersion: VersionTLS12
                cipherSuites:
                  - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
                  - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
                  - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256

    # ============================================
    # DOCKER COMPOSE
    # ============================================

    - name: Deploy Docker Compose file with Cloudflare credentials
      copy:
        dest: "{{ traefik_dir }}/docker-compose.yml"
        mode: "0644"
        content: |
          # Traefik with Let's Encrypt SSL via Cloudflare DNS
          # Features: OTEL Tracing, Prometheus Metrics, ForwardAuth
          name: traefik

          services:
            traefik:
              container_name: traefik
              image: traefik:{{ traefik_version }}
              restart: unless-stopped
              security_opt:
                - no-new-privileges:true
              ports:
                - "80:80"
                - "443:443"
                - "{{ metrics_port }}:{{ metrics_port }}"  # Prometheus metrics
                # Dashboard now accessible via HTTPS at traefik.{{ domain }}
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock:ro
                - {{ traefik_dir }}/config/traefik.yml:/etc/traefik/traefik.yml:ro
                - {{ traefik_dir }}/config/dynamic:/etc/traefik/dynamic:ro
                - {{ traefik_dir }}/certs:/certs
                - {{ traefik_dir }}/logs:/logs
              environment:
                - TZ={{ timezone }}
                - CF_DNS_API_TOKEN={{ cloudflare_api_token }}
              networks:
                - traefik-network
              healthcheck:
                test: ["CMD", "traefik", "healthcheck", "--ping"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 10s
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "5"

          networks:
            traefik-network:
              name: traefik-network
              driver: bridge

    # ============================================
    # DEPLOY THE STACK
    # ============================================

    - name: Stop existing Traefik container
      community.docker.docker_compose_v2:
        project_src: "{{ traefik_dir }}"
        state: absent
      ignore_errors: yes

    - name: Start Traefik with SSL configuration
      community.docker.docker_compose_v2:
        project_src: "{{ traefik_dir }}"
        state: present
        pull: always
      register: compose_result

    # ============================================
    # VERIFICATION
    # ============================================

    - name: Wait for Traefik to start and request certificates
      pause:
        seconds: 30
        prompt: "Waiting for Traefik to start and request SSL certificates..."

    - name: Check Traefik container status
      command: docker ps --format "table {{'{{'}}.Names{{'}}'}}\\t{{'{{'}}.Status{{'}}'}}\\t{{'{{'}}.Ports{{'}}'}}"
      register: container_status
      changed_when: false

    - name: Display container status
      debug:
        msg: "{{ container_status.stdout_lines }}"

    - name: Check Traefik logs for certificate status
      command: docker logs traefik --tail 50
      register: traefik_logs
      changed_when: false

    - name: Display certificate request status
      debug:
        msg: |
          ============================================
          TRAEFIK SSL DEPLOYMENT COMPLETE!
          ============================================

          Domain: {{ domain }}
          Certificate: Wildcard (*.{{ domain }})
          Features: OTEL Tracing, Prometheus Metrics, ForwardAuth

          IMPORTANT: Configure OPNsense DNS!
          ------------------------------------
          1. Go to: Services → Unbound DNS → Overrides
          2. Add Host Override:
             - Host: *
             - Domain: {{ domain }}
             - Type: A
             - IP: {{ ansible_host }}
          3. Apply changes

          Service URLs (after DNS configured):
          ------------------------------------
          Core Services:
            - https://traefik.{{ domain }}     (Dashboard - Protected)
            - https://auth.{{ domain }}        (Authentik)
            - https://photos.{{ domain }}      (Immich)
            - https://gitlab.{{ domain }}      (GitLab)

          Observability Services:
            - https://jaeger.{{ domain }}      (Distributed Tracing - Protected)
            - https://prometheus.{{ domain }}  (Metrics - Protected)
            - https://grafana.{{ domain }}     (Dashboards - Protected)
            - https://uptime.{{ domain }}      (Uptime Kuma - Protected)
            - https://demo.{{ domain }}        (Demo App - Protected)

          Media Services:
            - https://jellyfin.{{ domain }}    (Media Server - Protected)
            - https://radarr.{{ domain }}      (Movies - Protected)
            - https://sonarr.{{ domain }}      (TV Shows - Protected)
            - https://lidarr.{{ domain }}      (Music - Protected)
            - https://prowlarr.{{ domain }}    (Indexers - Protected)
            - https://bazarr.{{ domain }}      (Subtitles - Protected)
            - https://overseerr.{{ domain }}   (Requests - Protected)
            - https://jellyseerr.{{ domain }}  (Requests - Protected)
            - https://tdarr.{{ domain }}       (Transcoding - Protected)
            - https://autobrr.{{ domain }}     (Automation - Protected)

          Utility Services:
            - https://n8n.{{ domain }}         (Workflow Automation - Protected)
            - https://paperless.{{ domain }}   (Documents - Protected)
            - https://glance.{{ domain }}      (Dashboard - Protected)

          Metrics Endpoint:
          ------------------------------------
          Internal: http://{{ ansible_host }}:{{ metrics_port }}/metrics

          Verification:
          ------------------------------------
          # Check certificate status
          docker logs traefik | grep -i "certificate"

          # Check OTEL tracing
          docker logs traefik | grep -i "otel\|trace"

          # Test metrics endpoint
          curl http://{{ ansible_host }}:{{ metrics_port }}/metrics | head -20

          # View acme.json (contains certificates)
          cat {{ traefik_dir }}/certs/acme.json | jq '.letsencrypt'

          # Test HTTPS (after DNS)
          curl -v https://traefik.{{ domain }}

          ============================================
