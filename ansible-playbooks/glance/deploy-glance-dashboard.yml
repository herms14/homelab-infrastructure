---
# Glance Dashboard Deployment
# Deploys a comprehensive dashboard with all homelab monitoring widgets
#
# Features:
# - Proxmox health monitoring
# - Arr stack download progress
# - NBA scores
# - Bitcoin price
# - MSFT stock price
# - Network health via Omada/Prometheus
# - OPNsense Unbound stats
# - Kubernetes node status
# - Synology NAS monitoring (embedded Grafana dashboard)
#
# Usage:
#   ansible-playbook glance/deploy-glance-dashboard.yml

- name: Deploy Glance Dashboard
  hosts: docker-vm-utilities01
  become: yes
  vars:
    glance_path: /opt/glance
    glance_port: 8080

  tasks:
    - name: Create Glance directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ glance_path }}"
        - "{{ glance_path }}/config"
        - "{{ glance_path }}/assets"

    - name: Create custom themes CSS file
      copy:
        dest: "{{ glance_path }}/assets/custom-themes.css"
        content: |
          /*
           * Glance Dashboard Custom Themes CSS
           * ==================================
           * This file provides additional styling enhancements for all themes.
           * Theme colors are controlled via glance.yml presets.
           * Custom CSS provides layout, animation, and widget-specific styling.
           *
           * Available themes (select via picker icon in top-right):
           * - Midnight Blue: Deep blue professional
           * - Nord: Arctic cool colors
           * - Dracula: Popular purple theme
           * - Monokai: Classic code editor
           * - Catppuccin Mocha: Soft pastel (default)
           * - Gruvbox Dark: Warm retro
           * - Solarized Dark: Classic dark
           * - Tokyo Night: VSCode inspired
           * - Cyberpunk: Neon futuristic
           * - Classic Dark: Original theme
           */

          /* ========================================
             Base Enhancements
             ======================================== */

          /* Smooth theme transitions */
          * {
            transition: background-color 0.3s ease, color 0.2s ease, border-color 0.2s ease;
          }

          /* Enhanced card/widget styling */
          .widget {
            border-radius: 12px !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
          }

          .widget:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
          }

          /* ========================================
             Widget-Specific Styling
             ======================================== */

          /* Clock widget enhancements */
          .widget-type-clock {
            text-align: center;
          }

          .widget-type-clock .time {
            font-weight: 700;
            letter-spacing: -0.02em;
          }

          /* Weather widget */
          .widget-type-weather {
            padding: 1rem;
          }

          /* Bookmarks styling */
          .widget-type-bookmarks .bookmark-group {
            margin-bottom: 0.75rem;
          }

          .widget-type-bookmarks a {
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
          }

          .widget-type-bookmarks a:hover {
            transform: translateX(4px);
          }

          /* Monitor widget status indicators */
          .widget-type-monitor .monitor-site {
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
          }

          .widget-type-monitor .status-online {
            border-left: 3px solid hsl(var(--color-positive));
          }

          .widget-type-monitor .status-offline {
            border-left: 3px solid hsl(var(--color-negative));
          }

          /* Markets widget */
          .widget-type-markets .market-item {
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
          }

          /* RSS feed cards */
          .widget-type-rss .rss-card {
            border-radius: 10px;
            overflow: hidden;
          }

          .widget-type-rss .rss-card:hover {
            transform: scale(1.02);
          }

          /* iFrame widgets */
          .widget-type-iframe iframe {
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
          }

          /* ========================================
             Page Navigation Styling
             ======================================== */

          /* Tab navigation enhancement */
          .page-navigation {
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 0.5rem;
          }

          .page-navigation a {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
          }

          .page-navigation a:hover {
            background: rgba(255, 255, 255, 0.1);
          }

          .page-navigation a.active {
            font-weight: 600;
          }

          /* ========================================
             Theme Picker Enhancement
             ======================================== */

          /* Make theme picker more visible */
          .theme-picker-button {
            opacity: 0.7;
            transition: opacity 0.2s ease, transform 0.2s ease;
          }

          .theme-picker-button:hover {
            opacity: 1;
            transform: scale(1.1);
          }

          .theme-picker-dropdown {
            border-radius: 12px;
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
          }

          .theme-picker-option {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin: 0.25rem;
            transition: all 0.2s ease;
          }

          .theme-picker-option:hover {
            background: rgba(255, 255, 255, 0.1);
          }

          /* ========================================
             Custom API Widget Styling
             ======================================== */

          /* Life Progress widget specific */
          .widget-type-custom-api .progress-bar {
            border-radius: 4px;
            overflow: hidden;
          }

          /* Reddit feed custom styling */
          .widget-type-custom-api .reddit-post {
            border-radius: 8px;
            transition: background 0.2s ease;
          }

          .widget-type-custom-api .reddit-post:hover {
            background: rgba(255, 255, 255, 0.05);
          }

          /* ========================================
             Media Stats Grid Layout
             ======================================== */

          /* 3-column grid container for media stat cards */
          .media-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
            padding: 8px;
          }

          /* Individual stat card tile */
          .media-stat-card {
            height: 120px;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
          }

          .media-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          }

          /* Responsive: 2 columns on medium screens */
          @media (max-width: 1199px) {
            .media-stats-grid {
              grid-template-columns: repeat(2, minmax(0, 1fr));
            }
          }

          /* Responsive: 1 column on small screens */
          @media (max-width: 767px) {
            .media-stats-grid {
              grid-template-columns: 1fr;
            }
            .media-stat-card {
              height: 100px;
            }
          }

          /* ========================================
             Responsive Adjustments
             ======================================== */

          @media (max-width: 768px) {
            .widget {
              border-radius: 8px !important;
            }

            .widget:hover {
              transform: none;
            }
          }

          /* ========================================
             Animation Classes
             ======================================== */

          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
          }

          .widget {
            animation: fadeIn 0.3s ease-out;
          }

          /* Stagger animation for multiple widgets */
          .column > .widget:nth-child(1) { animation-delay: 0.05s; }
          .column > .widget:nth-child(2) { animation-delay: 0.1s; }
          .column > .widget:nth-child(3) { animation-delay: 0.15s; }
          .column > .widget:nth-child(4) { animation-delay: 0.2s; }
          .column > .widget:nth-child(5) { animation-delay: 0.25s; }

          /* ========================================
             Scrollbar Styling
             ======================================== */

          ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
          }

          ::-webkit-scrollbar-track {
            background: transparent;
          }

          ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
          }

          ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
          }

          /* ========================================
             Utility Classes
             ======================================== */

          .glow {
            box-shadow: 0 0 20px rgba(var(--color-primary), 0.3);
          }

          .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
          }
        mode: '0644'

    - name: Create Glance configuration
      copy:
        dest: "{{ glance_path }}/config/glance.yml"
        content: |
          server:
            port: 8080
            assets-path: /app/assets

          theme:
            # Default: Catppuccin Mocha - Soft, pastel dark theme
            background-color: 240 21 15
            contrast-multiplier: 1.2
            primary-color: 267 84 81
            positive-color: 115 54 76
            negative-color: 343 81 75
            custom-css-file: /app/assets/custom-themes.css

            # Theme Presets - Selectable from the theme picker icon (top-right)
            presets:
              # Deep blue professional dark theme
              midnight-blue:
                background-color: 213 58 10
                primary-color: 227 95 67
                positive-color: 162 82 40
                negative-color: 0 94 65
                contrast-multiplier: 1.2

              # Arctic, cool blue-gray palette
              nord:
                background-color: 220 16 22
                primary-color: 193 43 67
                positive-color: 92 28 65
                negative-color: 354 42 56
                contrast-multiplier: 1.1

              # Popular purple-based dark theme
              dracula:
                background-color: 231 15 18
                primary-color: 265 89 78
                positive-color: 135 94 65
                negative-color: 0 100 67
                contrast-multiplier: 1.2

              # Classic code editor theme
              monokai:
                background-color: 70 8 15
                primary-color: 338 95 56
                positive-color: 80 76 53
                negative-color: 338 95 56
                contrast-multiplier: 1.3

              # Soft pastel dark theme (Catppuccin Mocha)
              catppuccin-mocha:
                background-color: 240 21 15
                primary-color: 267 84 81
                positive-color: 115 54 76
                negative-color: 343 81 75
                contrast-multiplier: 1.2

              # Warm retro theme
              gruvbox-dark:
                background-color: 0 0 16
                primary-color: 43 95 58
                positive-color: 61 66 44
                negative-color: 5 96 59
                contrast-multiplier: 1.2

              # Ethan Schoonover's classic
              solarized-dark:
                background-color: 192 100 11
                primary-color: 205 69 49
                positive-color: 68 100 30
                negative-color: 1 71 52
                contrast-multiplier: 1.1

              # VSCode-inspired Japanese theme
              tokyo-night:
                background-color: 235 21 13
                primary-color: 218 87 73
                positive-color: 85 56 61
                negative-color: 348 86 70
                contrast-multiplier: 1.2

              # Neon futuristic theme
              cyberpunk:
                background-color: 240 33 8
                primary-color: 300 100 50
                positive-color: 158 100 50
                negative-color: 340 100 50
                contrast-multiplier: 1.4

              # Original default dark theme
              classic-dark:
                background-color: 240 8 9
                primary-color: 43 50 70
                positive-color: 43 50 70
                negative-color: 0 70 70
                contrast-multiplier: 1.0

          pages:
            - name: Home
              columns:
                - size: small
                  widgets:
                    - type: clock
                      hour-format: "24h"
                      timezone: Asia/Manila

                    - type: weather
                      location: Manila, Philippines
                      units: metric
                      hour-format: "24h"

                    - type: bookmarks
                      title: Quick Links
                      groups:
                        - title: Infrastructure
                          links:
                            - title: Proxmox
                              url: https://proxmox.hrmsmrflrii.xyz
                            - title: Traefik
                              url: https://traefik.hrmsmrflrii.xyz
                            - title: OPNsense
                              url: https://192.168.91.30
                            - title: Portainer
                              url: https://portainer.hrmsmrflrii.xyz

                        - title: Services
                          links:
                            - title: Jellyfin
                              url: https://jellyfin.hrmsmrflrii.xyz
                            - title: GitLab
                              url: https://gitlab.hrmsmrflrii.xyz
                            - title: Immich
                              url: https://photos.hrmsmrflrii.xyz
                            - title: n8n
                              url: https://n8n.hrmsmrflrii.xyz

                - size: full
                  widgets:
                    - type: custom-api
                      title: Hermes Miraflor II Life Progress
                      cache: 1h
                      url: http://192.168.40.10:5051/progress
                      template: |
                        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 10px;">
                          <div style="text-align: center; margin-bottom: 15px;">
                            <span style="color: #f87171; font-weight: 600; font-size: 18px;">{{ "{{" }} .JSON.Int "remaining_days" | formatNumber {{ "}}" }}</span>
                            <span style="color: #888; font-size: 14px;"> days remaining until age {{ "{{" }} .JSON.Int "target_age" {{ "}}" }}</span>
                          </div>
                          <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <span style="width: 60px; font-weight: bold; color: #f87171;">Year</span>
                            <div style="flex: 1; height: 24px; background: #333; border-radius: 4px; position: relative; margin: 0 15px; overflow: hidden;">
                              <div style="width: {{ "{{" }} .JSON.Float "year" {{ "}}" }}%; height: 100%; background: linear-gradient(90deg, #ef4444, #f87171); border-radius: 4px;"></div>
                            </div>
                            <span style="width: 50px; text-align: right; font-weight: 500;">{{ "{{" }} .JSON.Float "year" | printf "%.0f" {{ "}}" }}%</span>
                          </div>
                          <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <span style="width: 60px; font-weight: bold; color: #facc15;">Month</span>
                            <div style="flex: 1; height: 24px; background: #333; border-radius: 4px; position: relative; margin: 0 15px; overflow: hidden;">
                              <div style="width: {{ "{{" }} .JSON.Float "month" {{ "}}" }}%; height: 100%; background: linear-gradient(90deg, #eab308, #facc15); border-radius: 4px;"></div>
                            </div>
                            <span style="width: 50px; text-align: right; font-weight: 500;">{{ "{{" }} .JSON.Float "month" | printf "%.0f" {{ "}}" }}%</span>
                          </div>
                          <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <span style="width: 60px; font-weight: bold; color: #4ade80;">Day</span>
                            <div style="flex: 1; height: 24px; background: #333; border-radius: 4px; position: relative; margin: 0 15px; overflow: hidden;">
                              <div style="width: {{ "{{" }} .JSON.Float "day" {{ "}}" }}%; height: 100%; background: linear-gradient(90deg, #22c55e, #4ade80); border-radius: 4px;"></div>
                            </div>
                            <span style="width: 50px; text-align: right; font-weight: 500;">{{ "{{" }} .JSON.Float "day" | printf "%.0f" {{ "}}" }}%</span>
                          </div>
                          <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <span style="width: 60px; font-weight: bold; color: #4ade80;">Life</span>
                            <div style="flex: 1; height: 24px; background: #333; border-radius: 4px; position: relative; margin: 0 15px; overflow: hidden;">
                              <div style="width: {{ "{{" }} .JSON.Float "life" {{ "}}" }}%; height: 100%; background: linear-gradient(90deg, #22c55e, #4ade80); border-radius: 4px;"></div>
                            </div>
                            <span style="width: 50px; text-align: right; font-weight: 500;">{{ "{{" }} .JSON.Float "life" | printf "%.0f" {{ "}}" }}%</span>
                          </div>
                          <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <em style="color: #aaa; font-size: 13px; line-height: 1.5;">"{{ "{{" }} .JSON.String "quote" {{ "}}" }}"</em>
                          </div>
                        </div>

                    - type: monitor
                      title: Service Health
                      cache: 1m
                      sites:
                        - title: Proxmox Node 01
                          url: https://192.168.20.20:8006
                          icon: si:proxmox
                          allow-insecure: true
                        - title: Proxmox Node 02
                          url: https://192.168.20.21:8006
                          icon: si:proxmox
                          allow-insecure: true
                        - title: Proxmox Node 03
                          url: https://192.168.20.22:8006
                          icon: si:proxmox
                          allow-insecure: true
                        - title: Traefik
                          url: http://192.168.40.20:8082/ping
                          icon: si:traefikproxy
                        - title: Jellyfin
                          url: http://192.168.40.11:8096/health
                          icon: si:jellyfin
                        - title: Radarr
                          url: http://192.168.40.11:7878/ping
                          icon: si:radarr
                        - title: Sonarr
                          url: http://192.168.40.11:8989/ping
                          icon: si:sonarr
                        - title: GitLab
                          url: https://gitlab.hrmsmrflrii.xyz/users/sign_in
                          icon: si:gitlab
                        - title: Immich
                          url: http://192.168.40.22:2283/api/server/ping
                          icon: di:immich
                        - title: Authentik
                          url: http://192.168.40.21:9000/-/health/ready/
                          icon: si:authentik

                    - type: monitor
                      title: Kubernetes Cluster
                      cache: 1m
                      sites:
                        - title: K8s Controller 01
                          url: https://192.168.20.32:6443/healthz
                          icon: si:kubernetes
                          allow-insecure: true
                        - title: K8s Controller 02
                          url: https://192.168.20.33:6443/healthz
                          icon: si:kubernetes
                          allow-insecure: true
                        - title: K8s Controller 03
                          url: https://192.168.20.34:6443/healthz
                          icon: si:kubernetes
                          allow-insecure: true
                        - title: K8s Worker 01
                          url: http://192.168.20.40:10248/healthz
                          icon: si:kubernetes
                        - title: K8s Worker 02
                          url: http://192.168.20.41:10248/healthz
                          icon: si:kubernetes
                        - title: K8s Worker 03
                          url: http://192.168.20.42:10248/healthz
                          icon: si:kubernetes
                        - title: K8s Worker 04
                          url: http://192.168.20.43:10248/healthz
                          icon: si:kubernetes
                        - title: K8s Worker 05
                          url: http://192.168.20.44:10248/healthz
                          icon: si:kubernetes
                        - title: K8s Worker 06
                          url: http://192.168.20.45:10248/healthz
                          icon: si:kubernetes

                - size: small
                  widgets:
                    - type: markets
                      title: Markets
                      markets:
                        - symbol: BTC-USD
                          name: Bitcoin
                        - symbol: MSFT
                          name: Microsoft
                        - symbol: AAPL
                          name: Apple
                        - symbol: SPY
                          name: S&P 500

                    - type: rss
                      title: Tech News
                      style: horizontal-cards
                      feeds:
                        - url: https://www.reddit.com/r/homelab/.rss
                          title: r/homelab
                        - url: https://www.reddit.com/r/selfhosted/.rss
                          title: r/selfhosted
                      limit: 5

            - name: Media
              columns:
                - size: full
                  widgets:
                    - type: custom-api
                      title: Arr Stack Downloads
                      cache: 30s
                      url: http://192.168.40.11:7878/api/v3/queue
                      headers:
                        X-Api-Key: "${RADARR_API_KEY}"
                      template: |
                        {{ "{{" }} range .data.records {{ "}}" }}
                        {{ "{{" }} .title {{ "}}" }} - {{ "{{" }} .status {{ "}}" }}
                        {{ "{{" }} end {{ "}}" }}

                    - type: iframe
                      title: Radarr Calendar
                      source: http://192.168.40.11:7878/calendar
                      height: 300

                - size: small
                  widgets:
                    - type: bookmarks
                      title: Media Apps
                      groups:
                        - title: Arr Stack
                          links:
                            - title: Radarr
                              url: https://radarr.hrmsmrflrii.xyz
                            - title: Sonarr
                              url: https://sonarr.hrmsmrflrii.xyz
                            - title: Lidarr
                              url: https://lidarr.hrmsmrflrii.xyz
                            - title: Prowlarr
                              url: https://prowlarr.hrmsmrflrii.xyz
                            - title: Bazarr
                              url: https://bazarr.hrmsmrflrii.xyz
                            - title: Jellyseerr
                              url: https://jellyseerr.hrmsmrflrii.xyz

            - name: Sports
              columns:
                - size: full
                  widgets:
                    - type: custom-api
                      title: NBA Scores
                      cache: 5m
                      url: https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard
                      template: |
                        {{ "{{" }} range .events {{ "}}" }}
                        {{ "{{" }} .name {{ "}}" }} - {{ "{{" }} .status.type.shortDetail {{ "}}" }}
                        {{ "{{" }} range .competitions {{ "}}" }}
                          {{ "{{" }} range .competitors {{ "}}" }}
                            {{ "{{" }} .team.displayName {{ "}}" }}: {{ "{{" }} .score {{ "}}" }}
                          {{ "{{" }} end {{ "}}" }}
                        {{ "{{" }} end {{ "}}" }}
                        {{ "{{" }} end {{ "}}" }}

                    - type: custom-api
                      title: NFL Scores
                      cache: 5m
                      url: https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard
                      template: |
                        {{ "{{" }} range .events {{ "}}" }}
                        {{ "{{" }} .name {{ "}}" }} - {{ "{{" }} .status.type.shortDetail {{ "}}" }}
                        {{ "{{" }} end {{ "}}" }}

            - name: Network
              columns:
                - size: full
                  widgets:
                    - type: monitor
                      title: Network Devices
                      cache: 1m
                      sites:
                        - title: Core Router (ER605)
                          url: http://192.168.0.1
                          icon: di:tplink
                        - title: Core Switch (SG3210)
                          url: http://192.168.90.2
                          icon: di:tplink
                        - title: Morpheus Switch (SG2210P)
                          url: http://192.168.90.3
                          icon: di:tplink
                        - title: Atreus Switch (ES20GP)
                          url: http://192.168.90.51
                          icon: di:tplink
                        - title: OPNsense Firewall
                          url: https://192.168.91.30
                          allow-insecure: true
                          icon: si:opnsense
                        - title: Synology NAS
                          url: http://192.168.20.31:5000
                          icon: si:synology

                    - type: custom-api
                      title: OPNsense Unbound Statistics
                      cache: 1m
                      url: https://192.168.91.30/api/unbound/diagnostics/stats
                      headers:
                        Authorization: "Basic ${OPNSENSE_API_CREDENTIALS}"
                      allow-insecure: true
                      template: |
                        Total Queries: {{ "{{" }} .data.total.num.queries {{ "}}" }}
                        Cache Hits: {{ "{{" }} .data.total.num.cachehits {{ "}}" }}
                        Blocked: {{ "{{" }} .data.total.num.zero_ttl {{ "}}" }}

            - name: Storage
              columns:
                - size: full
                  widgets:
                    - type: iframe
                      title: Synology NAS Dashboard
                      source: https://grafana.hrmsmrflrii.xyz/d/synology-nas/synology-nas?orgId=1&kiosk&refresh=30s
                      height: 800

            - name: Containers
              columns:
                - size: full
                  widgets:
                    - type: iframe
                      title: Container Monitoring
                      source: https://grafana.hrmsmrflrii.xyz/d/container-monitoring/container-monitoring?orgId=1&kiosk&refresh=30s
                      height: 800

            - name: Reddit
              columns:
                - size: full
                  widgets:
                    - type: custom-api
                      title: Reddit Feed
                      cache: 5m
                      url: http://192.168.40.10:5053/api/feed
                      template: |
                        <div style="margin-bottom: 15px; text-align: right;">
                          <a href="http://192.168.40.10:5053" target="_blank" style="color: #ff4500; font-size: 12px; text-decoration: none; padding: 5px 10px; border: 1px solid #ff4500; border-radius: 6px;">
                            ⚙ Settings
                          </a>
                        </div>
                        {{ "{{" }} range .JSON.Array "groups" {{ "}}" }}
                        <div style="margin-bottom: 20px;">
                          <div style="color: #ff4500; font-size: 14px; font-weight: 600; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,69,0,0.3);">
                            r/{{ "{{" }} .String "name" {{ "}}" }}
                          </div>
                          {{ "{{" }} range .Array "posts" {{ "}}" }}
                          <div style="display: flex; padding: 8px; margin-bottom: 6px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            {{ "{{" }} if .String "thumbnail" {{ "}}" }}
                            <img src="{{ "{{" }} .String "thumbnail" {{ "}}" }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 10px; flex-shrink: 0;" onerror="this.style.display='none'">
                            {{ "{{" }} end {{ "}}" }}
                            <div style="flex: 1; min-width: 0;">
                              <a href="{{ "{{" }} .String "url" {{ "}}" }}" target="_blank" style="color: #fff; text-decoration: none; font-size: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                {{ "{{" }} .String "title" {{ "}}" }}
                              </a>
                              <div style="color: #888; font-size: 10px; margin-top: 3px;">
                                {{ "{{" }} .Int "score" {{ "}}" }} pts · {{ "{{" }} .Int "comments" {{ "}}" }} comments
                              </div>
                            </div>
                          </div>
                          {{ "{{" }} end {{ "}}" }}
                        </div>
                        {{ "{{" }} end {{ "}}" }}
        mode: '0644'

    - name: Create environment file for secrets
      copy:
        dest: "{{ glance_path }}/.env"
        content: |
          RADARR_API_KEY=21f807cf286941158e11ba6477853821
          SONARR_API_KEY=50c598d01b294f929e5ecf36ae42ad2e
          OPNSENSE_API_CREDENTIALS=base64_encoded_key:secret
        mode: '0600'

    - name: Create Docker Compose file
      copy:
        dest: "{{ glance_path }}/docker-compose.yml"
        content: |
          # Glance v0.7.0+ requires config directory mount (not single file)
          # See: https://github.com/glanceapp/glance/blob/main/docs/v0.7.0-upgrade.md
          services:
            glance:
              image: glanceapp/glance:latest
              container_name: glance
              restart: unless-stopped
              ports:
                - "{{ glance_port }}:8080"
              volumes:
                - ./config:/app/config
                - ./assets:/app/assets:ro
                - /etc/timezone:/etc/timezone:ro
                - /etc/localtime:/etc/localtime:ro
              env_file:
                - .env
              environment:
                - TZ=America/New_York
        mode: '0644'

    - name: Deploy Glance container
      community.docker.docker_compose_v2:
        project_src: "{{ glance_path }}"
        state: present
        pull: always

    - name: Wait for Glance to be ready
      uri:
        url: "http://localhost:{{ glance_port }}"
        status_code: [200]
      register: glance_status
      until: glance_status.status == 200
      retries: 30
      delay: 2

    - name: Display access information
      debug:
        msg: |
          ===========================================
          Glance Dashboard Deployed Successfully!
          ===========================================

          Access URL: http://192.168.40.10:{{ glance_port }}
          External URL: https://glance.hrmsmrflrii.xyz

          Dashboard Features:
          ------------------
          - Service Health Monitoring
          - Kubernetes Cluster Status
          - Bitcoin & Stock Prices (MSFT, AAPL, SPY)
          - NBA & NFL Scores
          - Network Device Status
          - Arr Stack Download Progress
          - OPNsense Unbound Statistics
          - Tech News from Reddit
          - Synology NAS Monitoring (Storage page - embedded Grafana)

          Theme Selection:
          ---------------
          Click the palette icon (top-right corner) to select themes:
          - Catppuccin Mocha (Default) - Soft pastel dark
          - Midnight Blue - Deep blue professional
          - Nord - Arctic cool colors
          - Dracula - Popular purple theme
          - Monokai - Classic code editor
          - Gruvbox Dark - Warm retro colors
          - Solarized Dark - Ethan Schoonover's classic
          - Tokyo Night - VSCode inspired
          - Cyberpunk - Neon futuristic
          - Classic Dark - Original minimal theme

          Files:
          ------
          Configuration: {{ glance_path }}/config/glance.yml
          Custom CSS: {{ glance_path }}/assets/custom-themes.css
          Secrets: {{ glance_path }}/.env

          To customize, edit glance.yml and restart:
          cd {{ glance_path }} && docker compose restart
