---
# Home Assistant Energy Dashboard Configuration
# Configures utility meters, cost sensors, and energy monitoring
#
# Prerequisites:
#   - Home Assistant deployed and onboarding complete
#   - Tapo integration installed via HACS
#   - Tapo P110 devices discovered
#
# Features:
#   - Utility meters for daily/monthly energy tracking
#   - Cost sensors at 14.32 PHP per kWh
#   - Energy dashboard configuration
#
# Usage:
#   ansible-playbook homeassistant/configure-energy-dashboard.yml
#
# Note: After running this playbook, restart Home Assistant
# and configure the energy dashboard via the UI

- name: Configure Home Assistant Energy Dashboard
  hosts: homeassistant-lxc
  become: yes
  vars:
    homeassistant_path: /opt/homeassistant
    electricity_rate: 14.32  # PHP per kWh
    tapo_devices:
      - name: pc_setup
        friendly_name: "PC Setup"
        entity_id: sensor.tapo_pc_setup_power
      - name: aircon
        friendly_name: "Aircon"
        entity_id: sensor.tapo_aircon_power
      - name: living_room_tv
        friendly_name: "Living Room TV"
        entity_id: sensor.tapo_living_room_tv_power
      - name: router_nas
        friendly_name: "Router/NAS"
        entity_id: sensor.tapo_router_nas_power

  tasks:
    - name: Create packages directory
      file:
        path: "{{ homeassistant_path }}/config/packages"
        state: directory
        owner: hermes-admin
        group: hermes-admin
        mode: '0755'

    - name: Create energy monitoring package
      copy:
        dest: "{{ homeassistant_path }}/config/packages/energy_monitoring.yaml"
        owner: hermes-admin
        group: hermes-admin
        mode: '0644'
        content: |
          # Energy Monitoring Package
          # Auto-generated by Ansible
          # Rate: {{ electricity_rate }} PHP per kWh

          # Utility Meters for Energy Tracking
          utility_meter:
          {% for device in tapo_devices %}
            energy_{{ device.name }}_daily:
              source: sensor.tapo_{{ device.name }}_energy
              name: "{{ device.friendly_name }} Daily Energy"
              cycle: daily

            energy_{{ device.name }}_monthly:
              source: sensor.tapo_{{ device.name }}_energy
              name: "{{ device.friendly_name }} Monthly Energy"
              cycle: monthly

          {% endfor %}
            # Total Energy Utility Meters
            total_energy_daily:
              source: sensor.total_power_consumption
              name: "Total Daily Energy"
              cycle: daily

            total_energy_monthly:
              source: sensor.total_power_consumption
              name: "Total Monthly Energy"
              cycle: monthly

          # Template Sensors for Cost Calculation
          template:
            - sensor:
          {% for device in tapo_devices %}
                # {{ device.friendly_name }} Cost Sensors
                - name: "{{ device.friendly_name }} Daily Cost"
                  unique_id: "{{ device.name }}_daily_cost"
                  unit_of_measurement: "PHP"
                  state: >-
                    {% raw %}{{ (states('sensor.energy_{% endraw %}{{ device.name }}{% raw %}_daily') | float(0) * {% endraw %}{{ electricity_rate }}{% raw %}) | round(2) }}{% endraw %}

                  icon: mdi:currency-php

                - name: "{{ device.friendly_name }} Monthly Cost"
                  unique_id: "{{ device.name }}_monthly_cost"
                  unit_of_measurement: "PHP"
                  state: >-
                    {% raw %}{{ (states('sensor.energy_{% endraw %}{{ device.name }}{% raw %}_monthly') | float(0) * {% endraw %}{{ electricity_rate }}{% raw %}) | round(2) }}{% endraw %}

                  icon: mdi:currency-php

          {% endfor %}
                # Total Cost Sensors
                - name: "Total Daily Cost"
                  unique_id: "total_daily_cost"
                  unit_of_measurement: "PHP"
                  state: >-
                    {% raw %}{{ (states('sensor.total_energy_daily') | float(0) * {% endraw %}{{ electricity_rate }}{% raw %}) | round(2) }}{% endraw %}

                  icon: mdi:currency-php

                - name: "Total Monthly Cost"
                  unique_id: "total_monthly_cost"
                  unit_of_measurement: "PHP"
                  state: >-
                    {% raw %}{{ (states('sensor.total_energy_monthly') | float(0) * {% endraw %}{{ electricity_rate }}{% raw %}) | round(2) }}{% endraw %}

                  icon: mdi:currency-php

                # Aggregated Power Sensor
                - name: "Total Power Consumption"
                  unique_id: "total_power_consumption"
                  unit_of_measurement: "W"
                  state: >-
                    {% raw %}{{ {% endraw %}
          {% for device in tapo_devices %}
                    {% raw %}states('{{ device.entity_id }}') | float(0){% endraw %}{% if not loop.last %} +{% endif %}

          {% endfor %}
                    {% raw %}}}{% endraw %}

                  icon: mdi:flash

          # Input Number for Electricity Rate (adjustable via UI)
          input_number:
            electricity_rate:
              name: "Electricity Rate (PHP/kWh)"
              min: 5
              max: 30
              step: 0.01
              unit_of_measurement: "PHP/kWh"
              icon: mdi:currency-php
              initial: {{ electricity_rate }}

    - name: Enable packages in configuration.yaml
      lineinfile:
        path: "{{ homeassistant_path }}/config/configuration.yaml"
        line: "homeassistant:\n  packages: !include_dir_named packages"
        insertbefore: BOF
        firstmatch: yes
      register: config_changed

    - name: Display next steps
      debug:
        msg: |
          Energy monitoring configuration created!

          Next Steps:
          1. Restart Home Assistant to apply changes
          2. Install HACS (Home Assistant Community Store):
             - Download: wget -O - https://get.hacs.xyz | bash -
             - Restart Home Assistant
             - Go to Settings > Devices & Services > Add Integration > HACS

          3. Install Tapo Integration via HACS:
             - Go to HACS > Integrations > Search "Tapo"
             - Install "Tapo Controller"
             - Restart Home Assistant
             - Go to Settings > Devices & Services > Add Integration > Tapo
             - Enter Tapo account credentials

          4. Configure Energy Dashboard:
             - Go to Settings > Dashboards > Energy
             - Add your energy sensors
             - Set grid consumption source

          5. Update entity IDs in packages/energy_monitoring.yaml
             to match your actual Tapo device entity IDs

          Electricity Rate: {{ electricity_rate }} PHP/kWh

          Important Files:
          - Configuration: {{ homeassistant_path }}/config/configuration.yaml
          - Energy Package: {{ homeassistant_path }}/config/packages/energy_monitoring.yaml
