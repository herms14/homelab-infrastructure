---
# Ansible playbook to deploy Omada Network Grafana Dashboard
# Dashboard UID: omada-network
# Glance Network Tab: Combines Omada, OPNsense, and Speedtest metrics
#
# Prerequisites:
#   1. Omada exporter running on port 9202
#   2. OPNsense exporter running on port 9198
#   3. Speedtest Tracker running on port 3000
#   4. Prometheus configured to scrape all exporters
#
# Usage:
#   ansible-playbook ansible-playbooks/monitoring/deploy-omada-network-dashboard.yml
#
# Environment Variables:
#   GRAFANA_API_KEY - Grafana API key with dashboard edit permissions

- name: Deploy Omada Network Dashboard to Grafana
  hosts: localhost
  gather_facts: false
  vars:
    grafana_url: "http://192.168.40.10:3030"
    grafana_api_key: "{{ lookup('env', 'GRAFANA_API_KEY') }}"
    dashboard_uid: "omada-network"
    dashboard_title: "Omada Network Overview"

  tasks:
    - name: Create Omada Network dashboard JSON
      set_fact:
        dashboard_json:
          dashboard:
            annotations:
              list: []
            editable: true
            fiscalYearStartMonth: 0
            graphTooltip: 1
            id: null
            links: []
            panels:
              # ========================================
              # ROW 1: Device Summary (y=0, h=4)
              # ========================================
              - type: stat
                title: Total Devices
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 3, x: 0, y: 0 }
                id: 1
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#3b82f6"
                          value: null
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'count(omada_device_uptime_seconds{job="omada"})'
                    refId: A

              - type: stat
                title: Gateway
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 3, x: 3, y: 0 }
                id: 2
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'count(omada_device_uptime_seconds{job="omada",device_type="gateway"}) or vector(1)'
                    refId: A

              - type: stat
                title: Switches
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 3, x: 6, y: 0 }
                id: 3
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#8b5cf6"
                          value: null
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'count(omada_device_uptime_seconds{job="omada",device_type="switch"}) or vector(3)'
                    refId: A

              - type: stat
                title: Access Points
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 3, x: 9, y: 0 }
                id: 4
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#06b6d4"
                          value: null
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'count(omada_device_uptime_seconds{job="omada",device_type="ap"}) or vector(3)'
                    refId: A

              # Client Stats
              - type: stat
                title: Total Clients
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 3, x: 12, y: 0 }
                id: 5
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                options:
                  colorMode: background
                  graphMode: area
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'omada_client_connected_total{job="omada"}'
                    refId: A

              - type: stat
                title: Wired Clients
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 3, x: 15, y: 0 }
                id: 6
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#f59e0b"
                          value: null
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'count(omada_client_traffic_down_bytes{job="omada",connection_mode="wired"})'
                    refId: A

              - type: stat
                title: Wireless Clients
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 3, x: 18, y: 0 }
                id: 7
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#ec4899"
                          value: null
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'count(omada_client_traffic_down_bytes{job="omada",connection_mode="wireless"})'
                    refId: A

              - type: stat
                title: Total Traffic
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 3, x: 21, y: 0 }
                id: 8
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#3b82f6"
                          value: null
                    unit: bytes
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'sum(omada_client_traffic_down_bytes{job="omada"}) + sum(omada_client_traffic_up_bytes{job="omada"})'
                    refId: A

              # ========================================
              # ROW 2: Gateway & ISP (y=4, h=6)
              # ========================================
              - type: gauge
                title: Gateway CPU
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 6, w: 4, x: 0, y: 4 }
                id: 10
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    decimals: 1
                    max: 100
                    min: 0
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                        - color: "#f59e0b"
                          value: 50
                        - color: "#ef4444"
                          value: 80
                    unit: percent
                options:
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  showThresholdLabels: false
                  showThresholdMarkers: true
                targets:
                  - expr: 'omada_device_cpu_percentage{job="omada",device_type="gateway"}'
                    refId: A

              - type: gauge
                title: Gateway Memory
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 6, w: 4, x: 4, y: 4 }
                id: 11
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    decimals: 1
                    max: 100
                    min: 0
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                        - color: "#f59e0b"
                          value: 70
                        - color: "#ef4444"
                          value: 90
                    unit: percent
                options:
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  showThresholdLabels: false
                  showThresholdMarkers: true
                targets:
                  - expr: 'omada_device_mem_percentage{job="omada",device_type="gateway"}'
                    refId: A

              - type: timeseries
                title: Gateway Utilization
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 6, w: 16, x: 8, y: 4 }
                id: 12
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: palette-classic
                    custom:
                      axisBorderShow: false
                      axisCenteredZero: false
                      axisColorMode: text
                      axisPlacement: auto
                      barAlignment: 0
                      drawStyle: line
                      fillOpacity: 20
                      gradientMode: opacity
                      hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                      lineInterpolation: smooth
                      lineWidth: 2
                      pointSize: 5
                      scaleDistribution:
                        type: linear
                      showPoints: never
                      spanNulls: false
                      stacking:
                        group: A
                        mode: none
                      thresholdsStyle:
                        mode: "off"
                    max: 100
                    min: 0
                    thresholds:
                      mode: absolute
                      steps:
                        - color: green
                          value: null
                    unit: percent
                  overrides:
                    - matcher:
                        id: byName
                        options: "CPU"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#22c55e"
                            mode: fixed
                    - matcher:
                        id: byName
                        options: "Memory"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#3b82f6"
                            mode: fixed
                options:
                  legend:
                    calcs: ["mean", "max"]
                    displayMode: table
                    placement: right
                    showLegend: true
                  tooltip:
                    mode: multi
                    sort: desc
                targets:
                  - expr: 'omada_device_cpu_percentage{job="omada",device_type="gateway"}'
                    legendFormat: "CPU"
                    refId: A
                  - expr: 'omada_device_mem_percentage{job="omada",device_type="gateway"}'
                    legendFormat: "Memory"
                    refId: B

              # ========================================
              # ROW 3: Client Connection Trend (y=10, h=7)
              # ========================================
              - type: timeseries
                title: Client Connection Trend
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 7, w: 16, x: 0, y: 10 }
                id: 20
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: palette-classic
                    custom:
                      axisBorderShow: false
                      axisCenteredZero: false
                      axisColorMode: text
                      axisPlacement: auto
                      barAlignment: 0
                      drawStyle: line
                      fillOpacity: 20
                      gradientMode: opacity
                      hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                      lineInterpolation: smooth
                      lineWidth: 2
                      pointSize: 5
                      scaleDistribution:
                        type: linear
                      showPoints: never
                      spanNulls: false
                      stacking:
                        group: A
                        mode: none
                      thresholdsStyle:
                        mode: "off"
                    thresholds:
                      mode: absolute
                      steps:
                        - color: green
                          value: null
                  overrides:
                    - matcher:
                        id: byName
                        options: "Total Clients"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#22c55e"
                            mode: fixed
                    - matcher:
                        id: byName
                        options: "Wired"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#3b82f6"
                            mode: fixed
                    - matcher:
                        id: byName
                        options: "Wireless"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#06b6d4"
                            mode: fixed
                options:
                  legend:
                    calcs: ["lastNotNull", "mean"]
                    displayMode: table
                    placement: right
                    showLegend: true
                  tooltip:
                    mode: multi
                    sort: desc
                targets:
                  - expr: 'omada_client_connected_total{job="omada"}'
                    legendFormat: "Total Clients"
                    refId: A
                  - expr: 'count(omada_client_traffic_down_bytes{job="omada",connection_mode="wired"})'
                    legendFormat: "Wired"
                    refId: B
                  - expr: 'count(omada_client_traffic_down_bytes{job="omada",connection_mode="wireless"})'
                    legendFormat: "Wireless"
                    refId: C

              # Speedtest Panel
              - type: stat
                title: Download Speed
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 3, w: 4, x: 16, y: 10 }
                id: 21
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#ef4444"
                          value: null
                        - color: "#f59e0b"
                          value: 50
                        - color: "#22c55e"
                          value: 100
                    unit: Mbps
                options:
                  colorMode: background
                  graphMode: area
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'speedtest_download_bits_per_second{job="speedtest"} / 1000000'
                    refId: A

              - type: stat
                title: Upload Speed
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 3, w: 4, x: 20, y: 10 }
                id: 22
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#ef4444"
                          value: null
                        - color: "#f59e0b"
                          value: 20
                        - color: "#22c55e"
                          value: 50
                    unit: Mbps
                options:
                  colorMode: background
                  graphMode: area
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'speedtest_upload_bits_per_second{job="speedtest"} / 1000000'
                    refId: A

              - type: stat
                title: Ping
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 4, x: 16, y: 13 }
                id: 23
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                        - color: "#f59e0b"
                          value: 30
                        - color: "#ef4444"
                          value: 100
                    unit: ms
                options:
                  colorMode: background
                  graphMode: area
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'speedtest_ping_latency_milliseconds{job="speedtest"}'
                    refId: A

              - type: stat
                title: Jitter
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 4, x: 20, y: 13 }
                id: 24
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                        - color: "#f59e0b"
                          value: 10
                        - color: "#ef4444"
                          value: 30
                    unit: ms
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'speedtest_ping_jitter_milliseconds{job="speedtest"}'
                    refId: A

              # ========================================
              # ROW 4: Traffic & Switches (y=17, h=7)
              # ========================================
              - type: timeseries
                title: Network Traffic (WAN)
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 7, w: 12, x: 0, y: 17 }
                id: 30
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: palette-classic
                    custom:
                      axisBorderShow: false
                      axisCenteredZero: false
                      axisColorMode: text
                      axisPlacement: auto
                      barAlignment: 0
                      drawStyle: line
                      fillOpacity: 20
                      gradientMode: opacity
                      hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                      lineInterpolation: smooth
                      lineWidth: 2
                      pointSize: 5
                      scaleDistribution:
                        type: linear
                      showPoints: never
                      spanNulls: false
                      stacking:
                        group: A
                        mode: none
                      thresholdsStyle:
                        mode: "off"
                    thresholds:
                      mode: absolute
                      steps:
                        - color: green
                          value: null
                    unit: Bps
                  overrides:
                    - matcher:
                        id: byName
                        options: "Download"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#22c55e"
                            mode: fixed
                    - matcher:
                        id: byName
                        options: "Upload"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#3b82f6"
                            mode: fixed
                options:
                  legend:
                    calcs: ["mean", "max"]
                    displayMode: table
                    placement: bottom
                    showLegend: true
                  tooltip:
                    mode: multi
                    sort: desc
                targets:
                  - expr: 'rate(opnsense_interfaces_received_bytes_total{interface="WAN"}[5m])'
                    legendFormat: "Download"
                    refId: A
                  - expr: 'rate(opnsense_interfaces_transmitted_bytes_total{interface="WAN"}[5m])'
                    legendFormat: "Upload"
                    refId: B

              - type: bargauge
                title: Switch Traffic (Top 5)
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 7, w: 6, x: 12, y: 17 }
                id: 31
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: continuous-GrYlRd
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                    unit: bytes
                options:
                  displayMode: gradient
                  minVizHeight: 10
                  minVizWidth: 0
                  namePlacement: auto
                  orientation: horizontal
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  showUnfilled: true
                  sizing: auto
                  valueMode: color
                targets:
                  - expr: 'topk(5, sum by (device) (omada_device_download{job="omada",device_type="switch"} + omada_device_upload{job="omada",device_type="switch"}))'
                    legendFormat: "{{device}}"
                    refId: A

              - type: bargauge
                title: PoE Power Usage
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 7, w: 6, x: 18, y: 17 }
                id: 32
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: continuous-BlPu
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#3b82f6"
                          value: null
                    unit: watt
                options:
                  displayMode: gradient
                  minVizHeight: 10
                  minVizWidth: 0
                  namePlacement: auto
                  orientation: horizontal
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  showUnfilled: true
                  sizing: auto
                  valueMode: color
                targets:
                  - expr: 'sum by (device) (omada_port_power_watts{job="omada"})'
                    legendFormat: "{{device}}"
                    refId: A

              # ========================================
              # ROW 5: APs & WiFi (y=24, h=7)
              # ========================================
              - type: bargauge
                title: Top APs by Client Count
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 7, w: 8, x: 0, y: 24 }
                id: 40
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: continuous-GrYlRd
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                options:
                  displayMode: gradient
                  minVizHeight: 10
                  minVizWidth: 0
                  namePlacement: auto
                  orientation: horizontal
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  showUnfilled: true
                  sizing: auto
                  valueMode: color
                targets:
                  - expr: 'count by (ap_name) (omada_client_traffic_down_bytes{job="omada",connection_mode="wireless"})'
                    legendFormat: "{{ap_name}}"
                    refId: A

              - type: bargauge
                title: Top APs by Traffic
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 7, w: 8, x: 8, y: 24 }
                id: 41
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: continuous-BlPu
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#3b82f6"
                          value: null
                    unit: bytes
                options:
                  displayMode: gradient
                  minVizHeight: 10
                  minVizWidth: 0
                  namePlacement: auto
                  orientation: horizontal
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  showUnfilled: true
                  sizing: auto
                  valueMode: color
                targets:
                  - expr: 'sum by (ap_name) (omada_client_traffic_down_bytes{job="omada",connection_mode="wireless"} + omada_client_traffic_up_bytes{job="omada",connection_mode="wireless"})'
                    legendFormat: "{{ap_name}}"
                    refId: A

              - type: piechart
                title: Clients by SSID
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 7, w: 8, x: 16, y: 24 }
                id: 42
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: palette-classic
                    custom:
                      hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                options:
                  displayLabels:
                    - name
                    - percent
                  legend:
                    displayMode: table
                    placement: right
                    showLegend: true
                    values:
                      - value
                      - percent
                  pieType: donut
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  tooltip:
                    mode: single
                    sort: none
                targets:
                  - expr: 'count by (ssid) (omada_client_traffic_down_bytes{job="omada",connection_mode="wireless"})'
                    legendFormat: "{{ssid}}"
                    refId: A

              # ========================================
              # ROW 6: OPNsense Firewall (y=31, h=6)
              # ========================================
              - type: stat
                title: OPNsense Gateway
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 4, x: 0, y: 31 }
                id: 50
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    mappings:
                      - options:
                          "1":
                            color: "#22c55e"
                            index: 0
                            text: "ONLINE"
                        type: value
                      - options:
                          match: "null"
                          result:
                            color: "#ef4444"
                            index: 1
                            text: "OFFLINE"
                        type: special
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#ef4444"
                          value: null
                        - color: "#22c55e"
                          value: 1
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'opnsense_gateways_info{name="WAN_GW"}'
                    refId: A

              - type: stat
                title: Services Running
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 4, x: 4, y: 31 }
                id: 51
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#22c55e"
                          value: null
                options:
                  colorMode: background
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'opnsense_services_running_total'
                    refId: A

              - type: stat
                title: Firewall Blocked
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 4, w: 4, x: 8, y: 31 }
                id: 52
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#f59e0b"
                          value: null
                options:
                  colorMode: background
                  graphMode: area
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'sum(opnsense_firewall_in_ipv4_block_packets{interface="igc1"})'
                    refId: A

              - type: timeseries
                title: Firewall Pass/Block Rate
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 6, w: 12, x: 12, y: 31 }
                id: 53
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: palette-classic
                    custom:
                      axisBorderShow: false
                      axisCenteredZero: false
                      axisColorMode: text
                      axisPlacement: auto
                      barAlignment: 0
                      drawStyle: line
                      fillOpacity: 20
                      gradientMode: opacity
                      hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                      lineInterpolation: smooth
                      lineWidth: 2
                      pointSize: 5
                      scaleDistribution:
                        type: linear
                      showPoints: never
                      spanNulls: false
                      stacking:
                        group: A
                        mode: none
                      thresholdsStyle:
                        mode: "off"
                    thresholds:
                      mode: absolute
                      steps:
                        - color: green
                          value: null
                    unit: pps
                  overrides:
                    - matcher:
                        id: byName
                        options: "Pass"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#22c55e"
                            mode: fixed
                    - matcher:
                        id: byName
                        options: "Block"
                      properties:
                        - id: color
                          value:
                            fixedColor: "#ef4444"
                            mode: fixed
                options:
                  legend:
                    calcs: ["mean", "max"]
                    displayMode: table
                    placement: bottom
                    showLegend: true
                  tooltip:
                    mode: multi
                    sort: desc
                targets:
                  - expr: 'rate(opnsense_firewall_in_ipv4_pass_packets{interface="igc1"}[5m])'
                    legendFormat: "Pass"
                    refId: A
                  - expr: 'rate(opnsense_firewall_in_ipv4_block_packets{interface="igc1"}[5m])'
                    legendFormat: "Block"
                    refId: B

              - type: stat
                title: TCP Connections
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 2, w: 4, x: 0, y: 35 }
                id: 54
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#3b82f6"
                          value: null
                options:
                  colorMode: value
                  graphMode: none
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'opnsense_protocol_tcp_connection_count_by_state{state="ESTABLISHED"}'
                    refId: A

              - type: stat
                title: DNS Queries (Unbound)
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 2, w: 4, x: 4, y: 35 }
                id: 55
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#8b5cf6"
                          value: null
                options:
                  colorMode: value
                  graphMode: area
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'increase(unbound_queries_total{job="opnsense"}[30m])'
                    refId: A

              - type: stat
                title: DNS Blocked (30m)
                datasource:
                  type: prometheus
                  uid: PBFA97CFB590B2093
                gridPos: { h: 2, w: 4, x: 8, y: 35 }
                id: 56
                transparent: true
                fieldConfig:
                  defaults:
                    color:
                      mode: thresholds
                    thresholds:
                      mode: absolute
                      steps:
                        - color: "#ef4444"
                          value: null
                options:
                  colorMode: background
                  graphMode: area
                  justifyMode: center
                  orientation: auto
                  reduceOptions:
                    calcs: ["lastNotNull"]
                    fields: ""
                    values: false
                  textMode: auto
                targets:
                  - expr: 'increase(unbound_blocked_queries_total{job="opnsense"}[30m]) or vector(0)'
                    refId: A

            refresh: "30s"
            schemaVersion: 39
            style: dark
            tags:
              - network
              - omada
              - opnsense
              - monitoring
            templating:
              list: []
            time:
              from: now-1h
              to: now
            timepicker: {}
            timezone: ""
            title: "{{ dashboard_title }}"
            uid: "{{ dashboard_uid }}"
            version: null
            weekStart: ""
          overwrite: true
          message: "Deployed via Ansible"

    - name: Deploy dashboard to Grafana
      uri:
        url: "{{ grafana_url }}/api/dashboards/db"
        method: POST
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
          Content-Type: "application/json"
        body: "{{ dashboard_json | to_json }}"
        body_format: json
        status_code: 200
        validate_certs: false
      register: deploy_result

    - name: Display deployment result
      debug:
        msg: "Dashboard deployed successfully. UID: {{ dashboard_uid }}, Version: {{ deploy_result.json.version }}"
