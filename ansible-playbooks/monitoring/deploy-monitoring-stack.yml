---
# Deploy Monitoring Stack (Uptime Kuma, Prometheus, Grafana)
# Target: docker-vm-utilities01 (192.168.40.10)
#
# Services:
#   - Uptime Kuma: Service uptime monitoring (port 3001)
#   - Prometheus: Metrics collection (port 9090)
#   - Grafana: Visualization dashboards (port 3030)
#   - PVE Exporter: Proxmox metrics for Prometheus
#
# Integrations:
#   - Jaeger datasource for distributed tracing
#   - Traefik metrics scraping
#   - OTEL Collector metrics scraping
#
# Usage:
#   ansible-playbook monitoring/deploy-monitoring-stack.yml

- name: Deploy Monitoring Stack
  hosts: docker_utilities
  become: yes
  vars:
    monitoring_dir: /opt/monitoring
    domain: "hrmsmrflrii.xyz"
    # Proxmox API credentials (set via environment or extra vars)
    pve_host: "192.168.20.21"
    pve_user: "{{ lookup('env', 'PVE_USER') | default('root@pam', true) }}"
    pve_password: "{{ lookup('env', 'PVE_PASSWORD') | default('') }}"
    # Service ports
    uptime_kuma_port: 3001
    prometheus_port: 9090
    grafana_port: 3030
    pve_exporter_port: 9221
    # External service IPs
    traefik_ip: "192.168.40.20"
    utilities_ip: "192.168.40.10"

  tasks:
    - name: Create monitoring directory structure
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ monitoring_dir }}"
        - "{{ monitoring_dir }}/prometheus"
        - "{{ monitoring_dir }}/prometheus/data"
        - "{{ monitoring_dir }}/grafana"
        - "{{ monitoring_dir }}/grafana/data"
        - "{{ monitoring_dir }}/grafana/provisioning"
        - "{{ monitoring_dir }}/grafana/provisioning/datasources"
        - "{{ monitoring_dir }}/grafana/provisioning/dashboards"
        - "{{ monitoring_dir }}/grafana/dashboards"
        - "{{ monitoring_dir }}/uptime-kuma"
        - "{{ monitoring_dir }}/pve-exporter"

    - name: Set Grafana data directory permissions
      file:
        path: "{{ monitoring_dir }}/grafana/data"
        state: directory
        mode: '0777'
        owner: '472'
        group: '472'
      ignore_errors: yes

    - name: Create Prometheus configuration
      copy:
        dest: "{{ monitoring_dir }}/prometheus/prometheus.yml"
        mode: '0644'
        content: |
          global:
            scrape_interval: 15s
            evaluation_interval: 15s
            external_labels:
              cluster: 'homelab'
              env: 'production'

          scrape_configs:
            # Prometheus self-monitoring
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
                  labels:
                    instance: 'prometheus'

            # Proxmox VE metrics via PVE Exporter
            - job_name: 'proxmox'
              static_configs:
                - targets:
                  - 192.168.20.20:8006  # node01
                  - 192.168.20.21:8006  # node02
                  - 192.168.20.22:8006  # node03
              metrics_path: /pve
              params:
                module: [default]
                cluster: ['1']
                node: ['1']
              relabel_configs:
                - source_labels: [__address__]
                  target_label: __param_target
                - source_labels: [__param_target]
                  target_label: instance
                - target_label: __address__
                  replacement: pve-exporter:9221

            # Traefik Metrics
            - job_name: 'traefik'
              static_configs:
                - targets: ['{{ traefik_ip }}:8082']
                  labels:
                    instance: 'traefik-primary'
              metrics_path: /metrics
              scheme: http

            # OpenTelemetry Collector Metrics
            - job_name: 'otel-collector'
              static_configs:
                - targets: ['{{ utilities_ip }}:8888']
                  labels:
                    instance: 'otel-collector'
              metrics_path: /metrics
              scheme: http

            # OTEL Collector Prometheus Exporter (pipeline metrics)
            - job_name: 'otel-collector-pipeline'
              static_configs:
                - targets: ['{{ utilities_ip }}:8889']
                  labels:
                    instance: 'otel-pipeline'
              metrics_path: /metrics
              scheme: http

            # Jaeger Metrics
            - job_name: 'jaeger'
              static_configs:
                - targets: ['{{ utilities_ip }}:14269']
                  labels:
                    instance: 'jaeger'
              metrics_path: /metrics
              scheme: http

            # Demo Application
            - job_name: 'demo-app'
              static_configs:
                - targets: ['{{ utilities_ip }}:8080']
                  labels:
                    instance: 'demo-app'
              metrics_path: /metrics
              scheme: http

            # Node Exporter for host metrics (optional, if installed)
            - job_name: 'node'
              static_configs:
                - targets: ['host.docker.internal:9100']

    - name: Create PVE Exporter configuration
      copy:
        dest: "{{ monitoring_dir }}/pve-exporter/pve.yml"
        mode: '0600'
        content: |
          default:
            user: {{ pve_user }}
            password: {{ pve_password }}
            verify_ssl: false

    - name: Create Grafana datasource provisioning
      copy:
        dest: "{{ monitoring_dir }}/grafana/provisioning/datasources/datasources.yml"
        mode: '0644'
        content: |
          apiVersion: 1
          datasources:
            # Prometheus - Metrics
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://prometheus:9090
              isDefault: true
              editable: true
              jsonData:
                httpMethod: POST
                manageAlerts: true
                prometheusType: Prometheus

            # Jaeger - Distributed Tracing
            - name: Jaeger
              type: jaeger
              access: proxy
              url: http://{{ utilities_ip }}:16686
              editable: true
              jsonData:
                tracesToLogsV2:
                  datasourceUid: ''
                  spanStartTimeShift: ''
                  spanEndTimeShift: ''
                  filterByTraceID: false
                  filterBySpanID: false
                tracesToMetrics:
                  datasourceUid: 'prometheus'
                  spanStartTimeShift: ''
                  spanEndTimeShift: ''
                nodeGraph:
                  enabled: true

    - name: Create Grafana dashboard provisioning
      copy:
        dest: "{{ monitoring_dir }}/grafana/provisioning/dashboards/default.yml"
        mode: '0644'
        content: |
          apiVersion: 1
          providers:
            - name: 'default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              updateIntervalSeconds: 10
              options:
                path: /var/lib/grafana/dashboards

    - name: Create Proxmox monitoring dashboard
      copy:
        dest: "{{ monitoring_dir }}/grafana/dashboards/proxmox-cluster.json"
        mode: '0644'
        content: |
          {
            "annotations": {
              "list": []
            },
            "editable": true,
            "fiscalYearStartMonth": 0,
            "graphTooltip": 0,
            "id": null,
            "links": [],
            "liveNow": false,
            "panels": [
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {
                      "mode": "thresholds"
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "red", "value": null},
                        {"color": "yellow", "value": 1},
                        {"color": "green", "value": 3}
                      ]
                    },
                    "unit": "none"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
                "id": 1,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto"
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "count(pve_up == 1)",
                    "refId": "A"
                  }
                ],
                "title": "Nodes Online",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "green", "value": null},
                        {"color": "yellow", "value": 70},
                        {"color": "red", "value": 90}
                      ]
                    },
                    "unit": "percent"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
                "id": 2,
                "options": {
                  "colorMode": "value",
                  "graphMode": "area",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto"
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "avg(pve_node_memory_usage_percentage)",
                    "refId": "A"
                  }
                ],
                "title": "Memory Usage %",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "green", "value": null}
                      ]
                    },
                    "unit": "bytes"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
                "id": 3,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto"
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "sum(pve_node_memory_used_bytes)",
                    "refId": "A"
                  }
                ],
                "title": "Memory Used",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "red", "value": null},
                        {"color": "yellow", "value": 10737418240},
                        {"color": "green", "value": 32212254720}
                      ]
                    },
                    "unit": "bytes"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
                "id": 4,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto"
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "sum(pve_node_memory_free_bytes)",
                    "refId": "A"
                  }
                ],
                "title": "Memory Free",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "green", "value": null},
                        {"color": "yellow", "value": 1},
                        {"color": "red", "value": 5}
                      ]
                    },
                    "unit": "none"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 4, "x": 0, "y": 4},
                "id": 5,
                "options": {
                  "colorMode": "background",
                  "graphMode": "none",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto"
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "sum(increase(pve_node_syslog_error_total[24h])) or vector(0)",
                    "refId": "A"
                  }
                ],
                "title": "Errors (24h)",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "green", "value": null},
                        {"color": "yellow", "value": 10},
                        {"color": "orange", "value": 50}
                      ]
                    },
                    "unit": "none"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 4, "x": 4, "y": 4},
                "id": 6,
                "options": {
                  "colorMode": "background",
                  "graphMode": "none",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto"
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "sum(increase(pve_node_syslog_warning_total[24h])) or vector(0)",
                    "refId": "A"
                  }
                ],
                "title": "Warnings (24h)",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "blue", "value": null}
                      ]
                    },
                    "unit": "none"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 4, "x": 8, "y": 4},
                "id": 7,
                "options": {
                  "colorMode": "background",
                  "graphMode": "none",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto"
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "sum(increase(pve_node_syslog_info_total[24h])) or vector(0)",
                    "refId": "A"
                  }
                ],
                "title": "Informational (24h)",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 20,
                      "gradientMode": "none",
                      "hideFrom": {"legend": false, "tooltip": false, "viz": false},
                      "lineInterpolation": "smooth",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": {"type": "linear"},
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": {"group": "A", "mode": "none"},
                      "thresholdsStyle": {"mode": "off"}
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [{"color": "green", "value": null}]
                    },
                    "unit": "percent"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
                "id": 8,
                "options": {
                  "legend": {"calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true},
                  "tooltip": {"mode": "multi", "sort": "none"}
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "pve_node_memory_usage_percentage",
                    "legendFormat": "{{instance}}",
                    "refId": "A"
                  }
                ],
                "title": "Memory Usage by Node",
                "type": "timeseries"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 20,
                      "gradientMode": "none",
                      "hideFrom": {"legend": false, "tooltip": false, "viz": false},
                      "lineInterpolation": "smooth",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": {"type": "linear"},
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": {"group": "A", "mode": "none"},
                      "thresholdsStyle": {"mode": "off"}
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [{"color": "green", "value": null}]
                    },
                    "unit": "percent"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
                "id": 9,
                "options": {
                  "legend": {"calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true},
                  "tooltip": {"mode": "multi", "sort": "none"}
                },
                "pluginVersion": "10.0.0",
                "targets": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "expr": "pve_node_cpu_usage_percentage",
                    "legendFormat": "{{instance}}",
                    "refId": "A"
                  }
                ],
                "title": "CPU Usage by Node",
                "type": "timeseries"
              }
            ],
            "refresh": "30s",
            "schemaVersion": 38,
            "style": "dark",
            "tags": ["proxmox", "infrastructure"],
            "templating": {"list": []},
            "time": {"from": "now-1h", "to": "now"},
            "timepicker": {},
            "timezone": "",
            "title": "Proxmox Cluster Overview",
            "uid": "proxmox-cluster",
            "version": 1,
            "weekStart": ""
          }

    - name: Create Traefik observability dashboard
      copy:
        dest: "{{ monitoring_dir }}/grafana/dashboards/traefik-observability.json"
        mode: '0644'
        content: |
          {
            "annotations": {"list": []},
            "editable": true,
            "fiscalYearStartMonth": 0,
            "graphTooltip": 1,
            "id": null,
            "links": [],
            "liveNow": false,
            "panels": [
              {
                "datasource": {"type": "prometheus", "uid": "prometheus"},
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                    "unit": "reqps"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
                "id": 1,
                "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                "pluginVersion": "10.0.0",
                "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(traefik_service_requests_total[5m]))", "refId": "A"}],
                "title": "Request Rate",
                "type": "stat"
              },
              {
                "datasource": {"type": "prometheus", "uid": "prometheus"},
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 0.5}, {"color": "red", "value": 1}]},
                    "unit": "s"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
                "id": 2,
                "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                "pluginVersion": "10.0.0",
                "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.95, sum(rate(traefik_service_request_duration_seconds_bucket[5m])) by (le))", "refId": "A"}],
                "title": "P95 Latency",
                "type": "stat"
              },
              {
                "datasource": {"type": "prometheus", "uid": "prometheus"},
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 1}, {"color": "red", "value": 5}]},
                    "unit": "percent"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
                "id": 3,
                "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                "pluginVersion": "10.0.0",
                "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(traefik_service_requests_total{code=~\"5..\"}[5m])) / sum(rate(traefik_service_requests_total[5m])) * 100 or vector(0)", "refId": "A"}],
                "title": "Error Rate %",
                "type": "stat"
              },
              {
                "datasource": {"type": "prometheus", "uid": "prometheus"},
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "mappings": [],
                    "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                    "unit": "none"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
                "id": 4,
                "options": {"colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                "pluginVersion": "10.0.0",
                "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "count(traefik_service_server_up)", "refId": "A"}],
                "title": "Active Services",
                "type": "stat"
              },
              {
                "datasource": {"type": "prometheus", "uid": "prometheus"},
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 20, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                    "mappings": [],
                    "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                    "unit": "reqps"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
                "id": 5,
                "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
                "pluginVersion": "10.0.0",
                "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(traefik_service_requests_total[5m])) by (service)", "legendFormat": "{{ '{{' }}service{{ '}}' }}", "refId": "A"}],
                "title": "Requests by Service",
                "type": "timeseries"
              },
              {
                "datasource": {"type": "prometheus", "uid": "prometheus"},
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 20, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                    "mappings": [],
                    "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                    "unit": "s"
                  },
                  "overrides": []
                },
                "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
                "id": 6,
                "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
                "pluginVersion": "10.0.0",
                "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.95, sum(rate(traefik_service_request_duration_seconds_bucket[5m])) by (le, service))", "legendFormat": "{{ '{{' }}service{{ '}}' }}", "refId": "A"}],
                "title": "P95 Latency by Service",
                "type": "timeseries"
              },
              {
                "datasource": {"type": "prometheus", "uid": "prometheus"},
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "bars", "fillOpacity": 100, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "normal"}, "thresholdsStyle": {"mode": "off"}},
                    "mappings": [],
                    "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                    "unit": "reqps"
                  },
                  "overrides": [
                    {"matcher": {"id": "byRegexp", "options": "2.."}, "properties": [{"id": "color", "value": {"fixedColor": "green", "mode": "fixed"}}]},
                    {"matcher": {"id": "byRegexp", "options": "3.."}, "properties": [{"id": "color", "value": {"fixedColor": "blue", "mode": "fixed"}}]},
                    {"matcher": {"id": "byRegexp", "options": "4.."}, "properties": [{"id": "color", "value": {"fixedColor": "yellow", "mode": "fixed"}}]},
                    {"matcher": {"id": "byRegexp", "options": "5.."}, "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]}
                  ]
                },
                "gridPos": {"h": 8, "w": 24, "x": 0, "y": 12},
                "id": 7,
                "options": {"legend": {"calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
                "pluginVersion": "10.0.0",
                "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(traefik_service_requests_total[5m])) by (code)", "legendFormat": "{{ '{{' }}code{{ '}}' }}", "refId": "A"}],
                "title": "Requests by Status Code",
                "type": "timeseries"
              }
            ],
            "refresh": "30s",
            "schemaVersion": 38,
            "style": "dark",
            "tags": ["traefik", "observability"],
            "templating": {"list": []},
            "time": {"from": "now-1h", "to": "now"},
            "timepicker": {},
            "timezone": "",
            "title": "Traefik Observability",
            "uid": "traefik-observability",
            "version": 1,
            "weekStart": ""
          }

    - name: Create Docker Compose file for monitoring stack
      copy:
        dest: "{{ monitoring_dir }}/docker-compose.yml"
        mode: '0644'
        content: |
          version: '3.8'

          services:
            # Uptime Kuma - Service uptime monitoring
            uptime-kuma:
              image: louislam/uptime-kuma:1
              container_name: uptime-kuma
              restart: unless-stopped
              ports:
                - "{{ uptime_kuma_port }}:3001"
              volumes:
                - ./uptime-kuma:/app/data
              networks:
                - monitoring

            # Prometheus - Metrics collection
            prometheus:
              image: prom/prometheus:latest
              container_name: prometheus
              restart: unless-stopped
              ports:
                - "{{ prometheus_port }}:9090"
              volumes:
                - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
                - ./prometheus/data:/prometheus
              command:
                - '--config.file=/etc/prometheus/prometheus.yml'
                - '--storage.tsdb.path=/prometheus'
                - '--web.enable-lifecycle'
                - '--storage.tsdb.retention.time=30d'
              networks:
                - monitoring

            # PVE Exporter - Proxmox metrics for Prometheus
            pve-exporter:
              image: prompve/prometheus-pve-exporter:latest
              container_name: pve-exporter
              restart: unless-stopped
              ports:
                - "{{ pve_exporter_port }}:9221"
              volumes:
                - ./pve-exporter/pve.yml:/etc/pve.yml:ro
              environment:
                - PVE_VERIFY_SSL=false
              networks:
                - monitoring

            # Grafana - Visualization and dashboards
            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              restart: unless-stopped
              ports:
                - "{{ grafana_port }}:3000"
              volumes:
                - ./grafana/data:/var/lib/grafana
                - ./grafana/provisioning:/etc/grafana/provisioning:ro
                - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
              environment:
                - GF_SECURITY_ADMIN_USER=admin
                - GF_SECURITY_ADMIN_PASSWORD=admin
                - GF_USERS_ALLOW_SIGN_UP=false
                - GF_SERVER_ROOT_URL=https://grafana.hrmsmrflrii.xyz
              depends_on:
                - prometheus
              networks:
                - monitoring

          networks:
            monitoring:
              driver: bridge

    - name: Deploy monitoring stack
      community.docker.docker_compose_v2:
        project_src: "{{ monitoring_dir }}"
        state: present
        pull: always
      register: compose_result

    - name: Wait for services to be ready
      wait_for:
        port: "{{ item }}"
        host: 127.0.0.1
        delay: 5
        timeout: 120
      loop:
        - "{{ uptime_kuma_port }}"
        - "{{ prometheus_port }}"
        - "{{ grafana_port }}"

    - name: Display deployment summary
      debug:
        msg:
          - "============================================"
          - "Monitoring Stack Deployed Successfully!"
          - "============================================"
          - ""
          - "Services:"
          - "  Uptime Kuma:  http://{{ utilities_ip }}:{{ uptime_kuma_port }}"
          - "  Prometheus:   http://{{ utilities_ip }}:{{ prometheus_port }}"
          - "  Grafana:      http://{{ utilities_ip }}:{{ grafana_port }}"
          - "  PVE Exporter: http://{{ utilities_ip }}:{{ pve_exporter_port }}"
          - ""
          - "External URLs (via Traefik):"
          - "  https://uptime.{{ domain }}"
          - "  https://prometheus.{{ domain }}"
          - "  https://grafana.{{ domain }}"
          - ""
          - "Grafana Credentials:"
          - "  Username: admin"
          - "  Password: admin (change on first login!)"
          - ""
          - "Datasources Configured:"
          - "  - Prometheus (default)"
          - "  - Jaeger (distributed tracing)"
          - ""
          - "Dashboards Configured:"
          - "  - Proxmox Cluster Overview"
          - "  - Traefik Observability"
          - ""
          - "Prometheus Scrape Targets:"
          - "  - Prometheus (self)"
          - "  - Proxmox VE (via PVE Exporter)"
          - "  - Traefik ({{ traefik_ip }}:8082)"
          - "  - OTEL Collector ({{ utilities_ip }}:8888, 8889)"
          - "  - Jaeger ({{ utilities_ip }}:14269)"
          - "  - Demo App ({{ utilities_ip }}:8080)"
          - ""
          - "Next Steps:"
          - "  1. Deploy observability stack (deploy-observability-stack.yml)"
          - "  2. Deploy updated Traefik config (deploy-traefik-ssl.yml)"
          - "  3. Set PVE_PASSWORD environment variable for Proxmox metrics"
          - "  4. View dashboards in Grafana"
          - "  5. Explore traces in Jaeger"
          - "============================================"
