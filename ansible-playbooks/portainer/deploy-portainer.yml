---
# Portainer Deployment Playbook
# Deploys Portainer CE for centralized Docker management
#
# Portainer will manage all Docker hosts in the homelab
#
# Usage:
#   ansible-playbook portainer/deploy-portainer.yml

- name: Deploy Portainer on docker-vm-utilities01
  hosts: docker-vm-utilities01
  become: yes
  vars:
    portainer_data_path: /opt/portainer
    portainer_port: 9000
    portainer_agent_port: 8000

  tasks:
    - name: Create Portainer data directory
      file:
        path: "{{ portainer_data_path }}"
        state: directory
        mode: '0755'

    - name: Create Docker network for Portainer
      docker_network:
        name: portainer_network
        state: present

    - name: Deploy Portainer CE container
      docker_container:
        name: portainer
        image: portainer/portainer-ce:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ portainer_port }}:9000"
          - "{{ portainer_agent_port }}:8000"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - "{{ portainer_data_path }}/data:/data"
        networks:
          - name: portainer_network

    - name: Wait for Portainer to be ready
      uri:
        url: "http://localhost:{{ portainer_port }}/api/status"
        status_code: [200]
      register: portainer_status
      until: portainer_status.status == 200
      retries: 30
      delay: 2

    - name: Display Portainer access info
      debug:
        msg: |
          Portainer deployed successfully!

          Access URL: http://192.168.40.10:{{ portainer_port }}
          External URL: https://portainer.hrmsmrflrii.xyz (after Traefik config)

          First-time setup:
          1. Navigate to the access URL
          2. Create admin account
          3. Choose "Get Started" to connect to local Docker

- name: Deploy Portainer Agent on all Docker hosts
  hosts: docker_hosts
  become: yes
  vars:
    agent_port: 9001

  tasks:
    - name: Deploy Portainer Agent container
      docker_container:
        name: portainer_agent
        image: portainer/agent:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ agent_port }}:9001"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - /var/lib/docker/volumes:/var/lib/docker/volumes

    - name: Display agent info
      debug:
        msg: |
          Portainer Agent deployed on {{ inventory_hostname }}
          Agent endpoint: {{ ansible_host }}:{{ agent_port }}

- name: Display final summary
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Show Docker host endpoints for Portainer
      debug:
        msg: |
          ===========================================
          Portainer Setup Complete!
          ===========================================

          Portainer UI: http://192.168.40.10:9000

          After first-time setup, add these endpoints:
          ------------------------------------------
          | Name                    | IP:Port            |
          |-------------------------|---------------------|
          | docker-vm-utilities01   | 192.168.40.10:9001 |
          | docker-vm-media01       | 192.168.40.11:9001 |
          | traefik-vm01            | 192.168.40.20:9001 |
          | authentik-vm01          | 192.168.40.21:9001 |
          | immich-vm01             | 192.168.40.22:9001 |
          | gitlab-vm01             | 192.168.40.23:9001 |
          ------------------------------------------

          Add Traefik route for external access:
          Edit /opt/traefik/config/dynamic/services.yml
