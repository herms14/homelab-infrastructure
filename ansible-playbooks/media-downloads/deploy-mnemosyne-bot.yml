---
# Mnemosyne - Media Guardian Discord Bot
# Goddess of Memory - Tracks and manages your media downloads
# Location: /opt/mnemosyne-bot/
#
# Features:
# - Real-time download notifications (50%, 80%, 100% progress)
# - Library browsing with /availablemovies, /availableseries
# - Radarr/Sonarr search and request functionality
# - Channel-restricted to media-downloads
#
# Commands:
# - /downloads       - Show current download queue
# - /search          - Search for movies/TV shows
# - /request         - Add media to Radarr/Sonarr
# - /availablemovies - List available movies in library
# - /availableseries - List available series in library
# - /showlist        - Quick compact media list
# - /stats           - Library statistics
# - /recent          - Recently added media
# - /quality         - View quality profiles
# - /mnemosyne       - Help command
#
# Prerequisites:
# - Discord bot token (create at https://discord.com/developers/applications)
# - Radarr/Sonarr API keys
#
# Usage:
#   MNEMOSYNE_DISCORD_TOKEN=xxx ansible-playbook media-downloads/deploy-mnemosyne-bot.yml

- name: Deploy Mnemosyne Discord Bot
  hosts: docker-vm-media01
  become: yes
  vars:
    bot_path: /opt/mnemosyne-bot
    # Discord Configuration
    discord_token: "{{ lookup('env', 'MNEMOSYNE_DISCORD_TOKEN') }}"
    # API Keys
    radarr_api_key: "{{ lookup('env', 'RADARR_API_KEY') | default('21f807cf286941158e11ba6477853821') }}"
    sonarr_api_key: "{{ lookup('env', 'SONARR_API_KEY') | default('50c598d01b294f929e5ecf36ae42ad2e') }}"
    # Service URLs
    radarr_url: "http://localhost:7878"
    sonarr_url: "http://localhost:8989"
    jellyfin_url: "https://jellyfin.hrmsmrflrii.xyz"
    # Polling interval in seconds
    poll_interval: 30
    # Channel restriction
    allowed_channels: "media-downloads"

  tasks:
    - name: Validate Discord token is set
      assert:
        that:
          - discord_token | length > 0
        fail_msg: |
          Missing required environment variable: MNEMOSYNE_DISCORD_TOKEN
          Create a Discord bot and set the token before deploying.

    - name: Create bot directory
      file:
        path: "{{ bot_path }}"
        state: directory
        mode: '0755'

    - name: Copy Python bot script
      copy:
        src: mnemosyne-bot.py
        dest: "{{ bot_path }}/mnemosyne-bot.py"
        mode: '0644'
      notify: Rebuild and restart bot

    - name: Copy requirements
      copy:
        src: requirements.txt
        dest: "{{ bot_path }}/requirements.txt"
        mode: '0644'
      notify: Rebuild and restart bot

    - name: Copy Dockerfile
      copy:
        src: Dockerfile
        dest: "{{ bot_path }}/Dockerfile"
        mode: '0644'
      notify: Rebuild and restart bot

    - name: Create Docker Compose file
      copy:
        dest: "{{ bot_path }}/docker-compose.yml"
        content: |
          services:
            mnemosyne-bot:
              build: .
              container_name: mnemosyne-bot
              restart: unless-stopped
              network_mode: host
              environment:
                # Discord Configuration
                - DISCORD_TOKEN={{ discord_token }}
                - ALLOWED_CHANNELS={{ allowed_channels }}

                # Radarr Configuration
                - RADARR_URL={{ radarr_url }}
                - RADARR_API_KEY={{ radarr_api_key }}

                # Sonarr Configuration
                - SONARR_URL={{ sonarr_url }}
                - SONARR_API_KEY={{ sonarr_api_key }}

                # Jellyfin Configuration
                - JELLYFIN_URL={{ jellyfin_url }}

                # Monitoring Configuration
                - POLL_INTERVAL={{ poll_interval }}
                - LOG_LEVEL=INFO
              healthcheck:
                test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
                interval: 60s
                timeout: 10s
                retries: 3
              logging:
                driver: json-file
                options:
                  max-size: "10m"
                  max-file: "3"
        mode: '0644'
      notify: Restart bot

    - name: Stop old download-monitor container if exists
      community.docker.docker_container:
        name: download-monitor
        state: absent
      ignore_errors: yes

    - name: Build and deploy Mnemosyne bot
      community.docker.docker_compose_v2:
        project_src: "{{ bot_path }}"
        state: present
        build: always

    - name: Wait for bot to start
      pause:
        seconds: 10

    - name: Check bot status
      command: docker logs mnemosyne-bot --tail 20
      register: bot_logs
      changed_when: false

    - name: Display deployment information
      debug:
        msg: |
          =====================================================
          Mnemosyne Media Guardian Deployed!
          =====================================================

          Container: mnemosyne-bot
          Host: docker-vm-media01 (192.168.40.11)
          Channel: #{{ allowed_channels }}

          Commands:
          ---------
          /downloads       - View current download queue
          /search          - Search for movies/TV shows
          /request         - Add media to download queue
          /availablemovies - List downloaded movies
          /availableseries - List downloaded series
          /showlist        - Quick compact media list
          /stats           - View library statistics
          /recent          - Recently added media
          /quality         - View quality profiles
          /mnemosyne       - Show help and bot info

          Automatic Notifications:
          ------------------------
          - Download started
          - Progress: 50%, 80%, 100%
          - Completion with Jellyfin link

          Logs: docker logs -f mnemosyne-bot

  handlers:
    - name: Rebuild and restart bot
      community.docker.docker_compose_v2:
        project_src: "{{ bot_path }}"
        state: present
        build: always

    - name: Restart bot
      community.docker.docker_compose_v2:
        project_src: "{{ bot_path }}"
        state: restarted
